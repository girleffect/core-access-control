

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>sqlalchemy.dialects.postgresql.base &mdash; access_control  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> access_control
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">access_control</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>sqlalchemy.dialects.postgresql.base</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sqlalchemy.dialects.postgresql.base</h1><div class="highlight"><pre>
<span></span><span class="c1"># postgresql/base.py</span>
<span class="c1"># Copyright (C) 2005-2018 the SQLAlchemy authors and contributors</span>
<span class="c1"># &lt;see AUTHORS file&gt;</span>
<span class="c1">#</span>
<span class="c1"># This module is part of SQLAlchemy and is released under</span>
<span class="c1"># the MIT License: http://www.opensource.org/licenses/mit-license.php</span>

<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. dialect:: postgresql</span>
<span class="sd">    :name: PostgreSQL</span>

<span class="sd">.. _postgresql_sequences:</span>

<span class="sd">Sequences/SERIAL/IDENTITY</span>
<span class="sd">-------------------------</span>

<span class="sd">PostgreSQL supports sequences, and SQLAlchemy uses these as the default means</span>
<span class="sd">of creating new primary key values for integer-based primary key columns. When</span>
<span class="sd">creating tables, SQLAlchemy will issue the ``SERIAL`` datatype for</span>
<span class="sd">integer-based primary key columns, which generates a sequence and server side</span>
<span class="sd">default corresponding to the column.</span>

<span class="sd">To specify a specific named sequence to be used for primary key generation,</span>
<span class="sd">use the :func:`~sqlalchemy.schema.Sequence` construct::</span>

<span class="sd">    Table(&#39;sometable&#39;, metadata,</span>
<span class="sd">            Column(&#39;id&#39;, Integer, Sequence(&#39;some_id_seq&#39;), primary_key=True)</span>
<span class="sd">        )</span>

<span class="sd">When SQLAlchemy issues a single INSERT statement, to fulfill the contract of</span>
<span class="sd">having the &quot;last insert identifier&quot; available, a RETURNING clause is added to</span>
<span class="sd">the INSERT statement which specifies the primary key columns should be</span>
<span class="sd">returned after the statement completes. The RETURNING functionality only takes</span>
<span class="sd">place if PostgreSQL 8.2 or later is in use. As a fallback approach, the</span>
<span class="sd">sequence, whether specified explicitly or implicitly via ``SERIAL``, is</span>
<span class="sd">executed independently beforehand, the returned value to be used in the</span>
<span class="sd">subsequent insert. Note that when an</span>
<span class="sd">:func:`~sqlalchemy.sql.expression.insert()` construct is executed using</span>
<span class="sd">&quot;executemany&quot; semantics, the &quot;last inserted identifier&quot; functionality does not</span>
<span class="sd">apply; no RETURNING clause is emitted nor is the sequence pre-executed in this</span>
<span class="sd">case.</span>

<span class="sd">To force the usage of RETURNING by default off, specify the flag</span>
<span class="sd">``implicit_returning=False`` to :func:`.create_engine`.</span>

<span class="sd">Postgresql 10 IDENTITY columns</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>

<span class="sd">Postgresql 10 has a new IDENTITY feature that supersedes the use of SERIAL.</span>
<span class="sd">Built-in support for rendering of IDENTITY is not available yet, however the</span>
<span class="sd">following compilation hook may be used to replace occurrences of SERIAL with</span>
<span class="sd">IDENTITY::</span>

<span class="sd">    from sqlalchemy.schema import CreateColumn</span>
<span class="sd">    from sqlalchemy.ext.compiler import compiles</span>


<span class="sd">    @compiles(CreateColumn, &#39;postgresql&#39;)</span>
<span class="sd">    def use_identity(element, compiler, **kw):</span>
<span class="sd">        text = compiler.visit_create_column(element, **kw)</span>
<span class="sd">        text = text.replace(&quot;SERIAL&quot;, &quot;INT GENERATED BY DEFAULT AS IDENTITY&quot;)</span>
<span class="sd">        return text</span>

<span class="sd">Using the above, a table such as::</span>

<span class="sd">    t = Table(</span>
<span class="sd">        &#39;t&#39;, m,</span>
<span class="sd">        Column(&#39;id&#39;, Integer, primary_key=True),</span>
<span class="sd">        Column(&#39;data&#39;, String)</span>
<span class="sd">    )</span>

<span class="sd">Will generate on the backing database as::</span>

<span class="sd">    CREATE TABLE t (</span>
<span class="sd">        id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL,</span>
<span class="sd">        data VARCHAR,</span>
<span class="sd">        PRIMARY KEY (id)</span>
<span class="sd">    )</span>

<span class="sd">.. _postgresql_isolation_level:</span>

<span class="sd">Transaction Isolation Level</span>
<span class="sd">---------------------------</span>

<span class="sd">All PostgreSQL dialects support setting of transaction isolation level</span>
<span class="sd">both via a dialect-specific parameter</span>
<span class="sd">:paramref:`.create_engine.isolation_level` accepted by :func:`.create_engine`,</span>
<span class="sd">as well as the :paramref:`.Connection.execution_options.isolation_level`</span>
<span class="sd">argument as passed to :meth:`.Connection.execution_options`.</span>
<span class="sd">When using a non-psycopg2 dialect, this feature works by issuing the command</span>
<span class="sd">``SET SESSION CHARACTERISTICS AS TRANSACTION ISOLATION LEVEL &lt;level&gt;`` for</span>
<span class="sd">each new connection.  For the special AUTOCOMMIT isolation level,</span>
<span class="sd">DBAPI-specific techniques are used.</span>

<span class="sd">To set isolation level using :func:`.create_engine`::</span>

<span class="sd">    engine = create_engine(</span>
<span class="sd">        &quot;postgresql+pg8000://scott:tiger@localhost/test&quot;,</span>
<span class="sd">        isolation_level=&quot;READ UNCOMMITTED&quot;</span>
<span class="sd">    )</span>

<span class="sd">To set using per-connection execution options::</span>

<span class="sd">    connection = engine.connect()</span>
<span class="sd">    connection = connection.execution_options(</span>
<span class="sd">        isolation_level=&quot;READ COMMITTED&quot;</span>
<span class="sd">    )</span>

<span class="sd">Valid values for ``isolation_level`` include:</span>

<span class="sd">* ``READ COMMITTED``</span>
<span class="sd">* ``READ UNCOMMITTED``</span>
<span class="sd">* ``REPEATABLE READ``</span>
<span class="sd">* ``SERIALIZABLE``</span>
<span class="sd">* ``AUTOCOMMIT`` - on psycopg2 / pg8000 only</span>

<span class="sd">.. seealso::</span>

<span class="sd">    :ref:`psycopg2_isolation_level`</span>

<span class="sd">    :ref:`pg8000_isolation_level`</span>

<span class="sd">.. _postgresql_schema_reflection:</span>

<span class="sd">Remote-Schema Table Introspection and PostgreSQL search_path</span>
<span class="sd">------------------------------------------------------------</span>

<span class="sd">The PostgreSQL dialect can reflect tables from any schema.  The</span>
<span class="sd">:paramref:`.Table.schema` argument, or alternatively the</span>
<span class="sd">:paramref:`.MetaData.reflect.schema` argument determines which schema will</span>
<span class="sd">be searched for the table or tables.   The reflected :class:`.Table` objects</span>
<span class="sd">will in all cases retain this ``.schema`` attribute as was specified.</span>
<span class="sd">However, with regards to tables which these :class:`.Table` objects refer to</span>
<span class="sd">via foreign key constraint, a decision must be made as to how the ``.schema``</span>
<span class="sd">is represented in those remote tables, in the case where that remote</span>
<span class="sd">schema name is also a member of the current</span>
<span class="sd">`PostgreSQL search path</span>
<span class="sd">&lt;http://www.postgresql.org/docs/current/static/ddl-schemas.html#DDL-SCHEMAS-PATH&gt;`_.</span>

<span class="sd">By default, the PostgreSQL dialect mimics the behavior encouraged by</span>
<span class="sd">PostgreSQL&#39;s own ``pg_get_constraintdef()`` builtin procedure.  This function</span>
<span class="sd">returns a sample definition for a particular foreign key constraint,</span>
<span class="sd">omitting the referenced schema name from that definition when the name is</span>
<span class="sd">also in the PostgreSQL schema search path.  The interaction below</span>
<span class="sd">illustrates this behavior::</span>

<span class="sd">    test=&gt; CREATE TABLE test_schema.referred(id INTEGER PRIMARY KEY);</span>
<span class="sd">    CREATE TABLE</span>
<span class="sd">    test=&gt; CREATE TABLE referring(</span>
<span class="sd">    test(&gt;         id INTEGER PRIMARY KEY,</span>
<span class="sd">    test(&gt;         referred_id INTEGER REFERENCES test_schema.referred(id));</span>
<span class="sd">    CREATE TABLE</span>
<span class="sd">    test=&gt; SET search_path TO public, test_schema;</span>
<span class="sd">    test=&gt; SELECT pg_catalog.pg_get_constraintdef(r.oid, true) FROM</span>
<span class="sd">    test-&gt; pg_catalog.pg_class c JOIN pg_catalog.pg_namespace n</span>
<span class="sd">    test-&gt; ON n.oid = c.relnamespace</span>
<span class="sd">    test-&gt; JOIN pg_catalog.pg_constraint r  ON c.oid = r.conrelid</span>
<span class="sd">    test-&gt; WHERE c.relname=&#39;referring&#39; AND r.contype = &#39;f&#39;</span>
<span class="sd">    test-&gt; ;</span>
<span class="sd">                   pg_get_constraintdef</span>
<span class="sd">    ---------------------------------------------------</span>
<span class="sd">     FOREIGN KEY (referred_id) REFERENCES referred(id)</span>
<span class="sd">    (1 row)</span>

<span class="sd">Above, we created a table ``referred`` as a member of the remote schema</span>
<span class="sd">``test_schema``, however when we added ``test_schema`` to the</span>
<span class="sd">PG ``search_path`` and then asked ``pg_get_constraintdef()`` for the</span>
<span class="sd">``FOREIGN KEY`` syntax, ``test_schema`` was not included in the output of</span>
<span class="sd">the function.</span>

<span class="sd">On the other hand, if we set the search path back to the typical default</span>
<span class="sd">of ``public``::</span>

<span class="sd">    test=&gt; SET search_path TO public;</span>
<span class="sd">    SET</span>

<span class="sd">The same query against ``pg_get_constraintdef()`` now returns the fully</span>
<span class="sd">schema-qualified name for us::</span>

<span class="sd">    test=&gt; SELECT pg_catalog.pg_get_constraintdef(r.oid, true) FROM</span>
<span class="sd">    test-&gt; pg_catalog.pg_class c JOIN pg_catalog.pg_namespace n</span>
<span class="sd">    test-&gt; ON n.oid = c.relnamespace</span>
<span class="sd">    test-&gt; JOIN pg_catalog.pg_constraint r  ON c.oid = r.conrelid</span>
<span class="sd">    test-&gt; WHERE c.relname=&#39;referring&#39; AND r.contype = &#39;f&#39;;</span>
<span class="sd">                         pg_get_constraintdef</span>
<span class="sd">    ---------------------------------------------------------------</span>
<span class="sd">     FOREIGN KEY (referred_id) REFERENCES test_schema.referred(id)</span>
<span class="sd">    (1 row)</span>

<span class="sd">SQLAlchemy will by default use the return value of ``pg_get_constraintdef()``</span>
<span class="sd">in order to determine the remote schema name.  That is, if our ``search_path``</span>
<span class="sd">were set to include ``test_schema``, and we invoked a table</span>
<span class="sd">reflection process as follows::</span>

<span class="sd">    &gt;&gt;&gt; from sqlalchemy import Table, MetaData, create_engine</span>
<span class="sd">    &gt;&gt;&gt; engine = create_engine(&quot;postgresql://scott:tiger@localhost/test&quot;)</span>
<span class="sd">    &gt;&gt;&gt; with engine.connect() as conn:</span>
<span class="sd">    ...     conn.execute(&quot;SET search_path TO test_schema, public&quot;)</span>
<span class="sd">    ...     meta = MetaData()</span>
<span class="sd">    ...     referring = Table(&#39;referring&#39;, meta,</span>
<span class="sd">    ...                       autoload=True, autoload_with=conn)</span>
<span class="sd">    ...</span>
<span class="sd">    &lt;sqlalchemy.engine.result.ResultProxy object at 0x101612ed0&gt;</span>

<span class="sd">The above process would deliver to the :attr:`.MetaData.tables` collection</span>
<span class="sd">``referred`` table named **without** the schema::</span>

<span class="sd">    &gt;&gt;&gt; meta.tables[&#39;referred&#39;].schema is None</span>
<span class="sd">    True</span>

<span class="sd">To alter the behavior of reflection such that the referred schema is</span>
<span class="sd">maintained regardless of the ``search_path`` setting, use the</span>
<span class="sd">``postgresql_ignore_search_path`` option, which can be specified as a</span>
<span class="sd">dialect-specific argument to both :class:`.Table` as well as</span>
<span class="sd">:meth:`.MetaData.reflect`::</span>

<span class="sd">    &gt;&gt;&gt; with engine.connect() as conn:</span>
<span class="sd">    ...     conn.execute(&quot;SET search_path TO test_schema, public&quot;)</span>
<span class="sd">    ...     meta = MetaData()</span>
<span class="sd">    ...     referring = Table(&#39;referring&#39;, meta, autoload=True,</span>
<span class="sd">    ...                       autoload_with=conn,</span>
<span class="sd">    ...                       postgresql_ignore_search_path=True)</span>
<span class="sd">    ...</span>
<span class="sd">    &lt;sqlalchemy.engine.result.ResultProxy object at 0x1016126d0&gt;</span>

<span class="sd">We will now have ``test_schema.referred`` stored as schema-qualified::</span>

<span class="sd">    &gt;&gt;&gt; meta.tables[&#39;test_schema.referred&#39;].schema</span>
<span class="sd">    &#39;test_schema&#39;</span>

<span class="sd">.. sidebar:: Best Practices for PostgreSQL Schema reflection</span>

<span class="sd">    The description of PostgreSQL schema reflection behavior is complex, and</span>
<span class="sd">    is the product of many years of dealing with widely varied use cases and</span>
<span class="sd">    user preferences. But in fact, there&#39;s no need to understand any of it if</span>
<span class="sd">    you just stick to the simplest use pattern: leave the ``search_path`` set</span>
<span class="sd">    to its default of ``public`` only, never refer to the name ``public`` as</span>
<span class="sd">    an explicit schema name otherwise, and refer to all other schema names</span>
<span class="sd">    explicitly when building up a :class:`.Table` object.  The options</span>
<span class="sd">    described here are only for those users who can&#39;t, or prefer not to, stay</span>
<span class="sd">    within these guidelines.</span>

<span class="sd">Note that **in all cases**, the &quot;default&quot; schema is always reflected as</span>
<span class="sd">``None``. The &quot;default&quot; schema on PostgreSQL is that which is returned by the</span>
<span class="sd">PostgreSQL ``current_schema()`` function.  On a typical PostgreSQL</span>
<span class="sd">installation, this is the name ``public``.  So a table that refers to another</span>
<span class="sd">which is in the ``public`` (i.e. default) schema will always have the</span>
<span class="sd">``.schema`` attribute set to ``None``.</span>

<span class="sd">.. versionadded:: 0.9.2 Added the ``postgresql_ignore_search_path``</span>
<span class="sd">   dialect-level option accepted by :class:`.Table` and</span>
<span class="sd">   :meth:`.MetaData.reflect`.</span>


<span class="sd">.. seealso::</span>

<span class="sd">        `The Schema Search Path</span>
<span class="sd">        &lt;http://www.postgresql.org/docs/9.0/static/ddl-schemas.html#DDL-SCHEMAS-PATH&gt;`_</span>
<span class="sd">        - on the PostgreSQL website.</span>

<span class="sd">INSERT/UPDATE...RETURNING</span>
<span class="sd">-------------------------</span>

<span class="sd">The dialect supports PG 8.2&#39;s ``INSERT..RETURNING``, ``UPDATE..RETURNING`` and</span>
<span class="sd">``DELETE..RETURNING`` syntaxes.   ``INSERT..RETURNING`` is used by default</span>
<span class="sd">for single-row INSERT statements in order to fetch newly generated</span>
<span class="sd">primary key identifiers.   To specify an explicit ``RETURNING`` clause,</span>
<span class="sd">use the :meth:`._UpdateBase.returning` method on a per-statement basis::</span>

<span class="sd">    # INSERT..RETURNING</span>
<span class="sd">    result = table.insert().returning(table.c.col1, table.c.col2).\</span>
<span class="sd">        values(name=&#39;foo&#39;)</span>
<span class="sd">    print result.fetchall()</span>

<span class="sd">    # UPDATE..RETURNING</span>
<span class="sd">    result = table.update().returning(table.c.col1, table.c.col2).\</span>
<span class="sd">        where(table.c.name==&#39;foo&#39;).values(name=&#39;bar&#39;)</span>
<span class="sd">    print result.fetchall()</span>

<span class="sd">    # DELETE..RETURNING</span>
<span class="sd">    result = table.delete().returning(table.c.col1, table.c.col2).\</span>
<span class="sd">        where(table.c.name==&#39;foo&#39;)</span>
<span class="sd">    print result.fetchall()</span>

<span class="sd">.. _postgresql_insert_on_conflict:</span>

<span class="sd">INSERT...ON CONFLICT (Upsert)</span>
<span class="sd">------------------------------</span>

<span class="sd">Starting with version 9.5, PostgreSQL allows &quot;upserts&quot; (update or insert)</span>
<span class="sd">of rows into a table via the ``ON CONFLICT`` clause of the ``INSERT`` statement.</span>
<span class="sd">A candidate row will only be inserted if that row does not violate</span>
<span class="sd">any unique constraints.  In the case of a unique constraint violation,</span>
<span class="sd">a secondary action can occur which can be either &quot;DO UPDATE&quot;, indicating</span>
<span class="sd">that the data in the target row should be updated, or &quot;DO NOTHING&quot;,</span>
<span class="sd">which indicates to silently skip this row.</span>

<span class="sd">Conflicts are determined using existing unique constraints and indexes.  These</span>
<span class="sd">constraints may be identified either using their name as stated in DDL,</span>
<span class="sd">or they may be *inferred* by stating the columns and conditions that comprise</span>
<span class="sd">the indexes.</span>

<span class="sd">SQLAlchemy provides ``ON CONFLICT`` support via the PostgreSQL-specific</span>
<span class="sd">:func:`.postgresql.dml.insert()` function, which provides</span>
<span class="sd">the generative methods :meth:`~.postgresql.dml.Insert.on_conflict_do_update`</span>
<span class="sd">and :meth:`~.postgresql.dml.Insert.on_conflict_do_nothing`::</span>

<span class="sd">    from sqlalchemy.dialects.postgresql import insert</span>

<span class="sd">    insert_stmt = insert(my_table).values(</span>
<span class="sd">        id=&#39;some_existing_id&#39;,</span>
<span class="sd">        data=&#39;inserted value&#39;)</span>

<span class="sd">    do_nothing_stmt = insert_stmt.on_conflict_do_nothing(</span>
<span class="sd">        index_elements=[&#39;id&#39;]</span>
<span class="sd">    )</span>

<span class="sd">    conn.execute(do_nothing_stmt)</span>

<span class="sd">    do_update_stmt = insert_stmt.on_conflict_do_update(</span>
<span class="sd">        constraint=&#39;pk_my_table&#39;,</span>
<span class="sd">        set_=dict(data=&#39;updated value&#39;)</span>
<span class="sd">    )</span>

<span class="sd">    conn.execute(do_update_stmt)</span>

<span class="sd">Both methods supply the &quot;target&quot; of the conflict using either the</span>
<span class="sd">named constraint or by column inference:</span>

<span class="sd">* The :paramref:`.Insert.on_conflict_do_update.index_elements` argument</span>
<span class="sd">  specifies a sequence containing string column names, :class:`.Column` objects,</span>
<span class="sd">  and/or SQL expression elements, which would identify a unique index::</span>

<span class="sd">    do_update_stmt = insert_stmt.on_conflict_do_update(</span>
<span class="sd">        index_elements=[&#39;id&#39;],</span>
<span class="sd">        set_=dict(data=&#39;updated value&#39;)</span>
<span class="sd">    )</span>

<span class="sd">    do_update_stmt = insert_stmt.on_conflict_do_update(</span>
<span class="sd">        index_elements=[my_table.c.id],</span>
<span class="sd">        set_=dict(data=&#39;updated value&#39;)</span>
<span class="sd">    )</span>

<span class="sd">* When using :paramref:`.Insert.on_conflict_do_update.index_elements` to</span>
<span class="sd">  infer an index, a partial index can be inferred by also specifying the</span>
<span class="sd">  use the :paramref:`.Insert.on_conflict_do_update.index_where` parameter::</span>

<span class="sd">    from sqlalchemy.dialects.postgresql import insert</span>

<span class="sd">    stmt = insert(my_table).values(user_email=&#39;a@b.com&#39;, data=&#39;inserted data&#39;)</span>
<span class="sd">    stmt = stmt.on_conflict_do_update(</span>
<span class="sd">        index_elements=[my_table.c.user_email],</span>
<span class="sd">        index_where=my_table.c.user_email.like(&#39;%@gmail.com&#39;),</span>
<span class="sd">        set_=dict(data=stmt.excluded.data)</span>
<span class="sd">        )</span>
<span class="sd">    conn.execute(stmt)</span>


<span class="sd">* The :paramref:`.Insert.on_conflict_do_update.constraint` argument is</span>
<span class="sd">  used to specify an index directly rather than inferring it.  This can be</span>
<span class="sd">  the name of a UNIQUE constraint, a PRIMARY KEY constraint, or an INDEX::</span>

<span class="sd">    do_update_stmt = insert_stmt.on_conflict_do_update(</span>
<span class="sd">        constraint=&#39;my_table_idx_1&#39;,</span>
<span class="sd">        set_=dict(data=&#39;updated value&#39;)</span>
<span class="sd">    )</span>

<span class="sd">    do_update_stmt = insert_stmt.on_conflict_do_update(</span>
<span class="sd">        constraint=&#39;my_table_pk&#39;,</span>
<span class="sd">        set_=dict(data=&#39;updated value&#39;)</span>
<span class="sd">    )</span>

<span class="sd">* The :paramref:`.Insert.on_conflict_do_update.constraint` argument may</span>
<span class="sd">  also refer to a SQLAlchemy construct representing a constraint,</span>
<span class="sd">  e.g. :class:`.UniqueConstraint`, :class:`.PrimaryKeyConstraint`,</span>
<span class="sd">  :class:`.Index`, or :class:`.ExcludeConstraint`.   In this use,</span>
<span class="sd">  if the constraint has a name, it is used directly.  Otherwise, if the</span>
<span class="sd">  constraint is unnamed, then inference will be used, where the expressions</span>
<span class="sd">  and optional WHERE clause of the constraint will be spelled out in the</span>
<span class="sd">  construct.  This use is especially convenient</span>
<span class="sd">  to refer to the named or unnamed primary key of a :class:`.Table` using the</span>
<span class="sd">  :attr:`.Table.primary_key` attribute::</span>

<span class="sd">    do_update_stmt = insert_stmt.on_conflict_do_update(</span>
<span class="sd">        constraint=my_table.primary_key,</span>
<span class="sd">        set_=dict(data=&#39;updated value&#39;)</span>
<span class="sd">    )</span>

<span class="sd">``ON CONFLICT...DO UPDATE`` is used to perform an update of the already</span>
<span class="sd">existing row, using any combination of new values as well as values</span>
<span class="sd">from the proposed insertion.   These values are specified using the</span>
<span class="sd">:paramref:`.Insert.on_conflict_do_update.set_` parameter.  This</span>
<span class="sd">parameter accepts a dictionary which consists of direct values</span>
<span class="sd">for UPDATE::</span>

<span class="sd">    from sqlalchemy.dialects.postgresql import insert</span>

<span class="sd">    stmt = insert(my_table).values(id=&#39;some_id&#39;, data=&#39;inserted value&#39;)</span>
<span class="sd">    do_update_stmt = stmt.on_conflict_do_update(</span>
<span class="sd">        index_elements=[&#39;id&#39;],</span>
<span class="sd">        set_=dict(data=&#39;updated value&#39;)</span>
<span class="sd">        )</span>
<span class="sd">    conn.execute(do_update_stmt)</span>

<span class="sd">.. warning::</span>

<span class="sd">    The :meth:`.Insert.on_conflict_do_update` method does **not** take into</span>
<span class="sd">    account Python-side default UPDATE values or generation functions, e.g.</span>
<span class="sd">    e.g. those specified using :paramref:`.Column.onupdate`.</span>
<span class="sd">    These values will not be exercised for an ON CONFLICT style of UPDATE,</span>
<span class="sd">    unless they are manually specified in the</span>
<span class="sd">    :paramref:`.Insert.on_conflict_do_update.set_` dictionary.</span>

<span class="sd">In order to refer to the proposed insertion row, the special alias</span>
<span class="sd">:attr:`~.postgresql.dml.Insert.excluded` is available as an attribute on</span>
<span class="sd">the :class:`.postgresql.dml.Insert` object; this object is a</span>
<span class="sd">:class:`.ColumnCollection` which alias contains all columns of the target</span>
<span class="sd">table::</span>

<span class="sd">    from sqlalchemy.dialects.postgresql import insert</span>

<span class="sd">    stmt = insert(my_table).values(</span>
<span class="sd">        id=&#39;some_id&#39;,</span>
<span class="sd">        data=&#39;inserted value&#39;,</span>
<span class="sd">        author=&#39;jlh&#39;)</span>
<span class="sd">    do_update_stmt = stmt.on_conflict_do_update(</span>
<span class="sd">        index_elements=[&#39;id&#39;],</span>
<span class="sd">        set_=dict(data=&#39;updated value&#39;, author=stmt.excluded.author)</span>
<span class="sd">        )</span>
<span class="sd">    conn.execute(do_update_stmt)</span>

<span class="sd">The :meth:`.Insert.on_conflict_do_update` method also accepts</span>
<span class="sd">a WHERE clause using the :paramref:`.Insert.on_conflict_do_update.where`</span>
<span class="sd">parameter, which will limit those rows which receive an UPDATE::</span>

<span class="sd">    from sqlalchemy.dialects.postgresql import insert</span>

<span class="sd">    stmt = insert(my_table).values(</span>
<span class="sd">        id=&#39;some_id&#39;,</span>
<span class="sd">        data=&#39;inserted value&#39;,</span>
<span class="sd">        author=&#39;jlh&#39;)</span>
<span class="sd">    on_update_stmt = stmt.on_conflict_do_update(</span>
<span class="sd">        index_elements=[&#39;id&#39;],</span>
<span class="sd">        set_=dict(data=&#39;updated value&#39;, author=stmt.excluded.author)</span>
<span class="sd">        where=(my_table.c.status == 2)</span>
<span class="sd">        )</span>
<span class="sd">    conn.execute(on_update_stmt)</span>

<span class="sd">``ON CONFLICT`` may also be used to skip inserting a row entirely</span>
<span class="sd">if any conflict with a unique or exclusion constraint occurs; below</span>
<span class="sd">this is illustrated using the</span>
<span class="sd">:meth:`~.postgresql.dml.Insert.on_conflict_do_nothing` method::</span>

<span class="sd">    from sqlalchemy.dialects.postgresql import insert</span>

<span class="sd">    stmt = insert(my_table).values(id=&#39;some_id&#39;, data=&#39;inserted value&#39;)</span>
<span class="sd">    stmt = stmt.on_conflict_do_nothing(index_elements=[&#39;id&#39;])</span>
<span class="sd">    conn.execute(stmt)</span>

<span class="sd">If ``DO NOTHING`` is used without specifying any columns or constraint,</span>
<span class="sd">it has the effect of skipping the INSERT for any unique or exclusion</span>
<span class="sd">constraint violation which occurs::</span>

<span class="sd">    from sqlalchemy.dialects.postgresql import insert</span>

<span class="sd">    stmt = insert(my_table).values(id=&#39;some_id&#39;, data=&#39;inserted value&#39;)</span>
<span class="sd">    stmt = stmt.on_conflict_do_nothing()</span>
<span class="sd">    conn.execute(stmt)</span>

<span class="sd">.. versionadded:: 1.1 Added support for PostgreSQL ON CONFLICT clauses</span>

<span class="sd">.. seealso::</span>

<span class="sd">    `INSERT .. ON CONFLICT &lt;http://www.postgresql.org/docs/current/static/sql-insert.html#SQL-ON-CONFLICT&gt;`_ - in the PostgreSQL documentation.</span>

<span class="sd">.. _postgresql_match:</span>

<span class="sd">Full Text Search</span>
<span class="sd">----------------</span>

<span class="sd">SQLAlchemy makes available the PostgreSQL ``@@`` operator via the</span>
<span class="sd">:meth:`.ColumnElement.match` method on any textual column expression.</span>
<span class="sd">On a PostgreSQL dialect, an expression like the following::</span>

<span class="sd">    select([sometable.c.text.match(&quot;search string&quot;)])</span>

<span class="sd">will emit to the database::</span>

<span class="sd">    SELECT text @@ to_tsquery(&#39;search string&#39;) FROM table</span>

<span class="sd">The PostgreSQL text search functions such as ``to_tsquery()``</span>
<span class="sd">and ``to_tsvector()`` are available</span>
<span class="sd">explicitly using the standard :data:`.func` construct.  For example::</span>

<span class="sd">    select([</span>
<span class="sd">        func.to_tsvector(&#39;fat cats ate rats&#39;).match(&#39;cat &amp; rat&#39;)</span>
<span class="sd">    ])</span>

<span class="sd">Emits the equivalent of::</span>

<span class="sd">    SELECT to_tsvector(&#39;fat cats ate rats&#39;) @@ to_tsquery(&#39;cat &amp; rat&#39;)</span>

<span class="sd">The :class:`.postgresql.TSVECTOR` type can provide for explicit CAST::</span>

<span class="sd">    from sqlalchemy.dialects.postgresql import TSVECTOR</span>
<span class="sd">    from sqlalchemy import select, cast</span>
<span class="sd">    select([cast(&quot;some text&quot;, TSVECTOR)])</span>

<span class="sd">produces a statement equivalent to::</span>

<span class="sd">    SELECT CAST(&#39;some text&#39; AS TSVECTOR) AS anon_1</span>

<span class="sd">Full Text Searches in PostgreSQL are influenced by a combination of: the</span>
<span class="sd">PostgresSQL setting of ``default_text_search_config``, the ``regconfig`` used</span>
<span class="sd">to build the GIN/GiST indexes, and the ``regconfig`` optionally passed in</span>
<span class="sd">during a query.</span>

<span class="sd">When performing a Full Text Search against a column that has a GIN or</span>
<span class="sd">GiST index that is already pre-computed (which is common on full text</span>
<span class="sd">searches) one may need to explicitly pass in a particular PostgresSQL</span>
<span class="sd">``regconfig`` value to ensure the query-planner utilizes the index and does</span>
<span class="sd">not re-compute the column on demand.</span>

<span class="sd">In order to provide for this explicit query planning, or to use different</span>
<span class="sd">search strategies, the ``match`` method accepts a ``postgresql_regconfig``</span>
<span class="sd">keyword argument::</span>

<span class="sd">    select([mytable.c.id]).where(</span>
<span class="sd">        mytable.c.title.match(&#39;somestring&#39;, postgresql_regconfig=&#39;english&#39;)</span>
<span class="sd">    )</span>

<span class="sd">Emits the equivalent of::</span>

<span class="sd">    SELECT mytable.id FROM mytable</span>
<span class="sd">    WHERE mytable.title @@ to_tsquery(&#39;english&#39;, &#39;somestring&#39;)</span>

<span class="sd">One can also specifically pass in a `&#39;regconfig&#39;` value to the</span>
<span class="sd">``to_tsvector()`` command as the initial argument::</span>

<span class="sd">    select([mytable.c.id]).where(</span>
<span class="sd">            func.to_tsvector(&#39;english&#39;, mytable.c.title )\</span>
<span class="sd">            .match(&#39;somestring&#39;, postgresql_regconfig=&#39;english&#39;)</span>
<span class="sd">        )</span>

<span class="sd">produces a statement equivalent to::</span>

<span class="sd">    SELECT mytable.id FROM mytable</span>
<span class="sd">    WHERE to_tsvector(&#39;english&#39;, mytable.title) @@</span>
<span class="sd">        to_tsquery(&#39;english&#39;, &#39;somestring&#39;)</span>

<span class="sd">It is recommended that you use the ``EXPLAIN ANALYZE...`` tool from</span>
<span class="sd">PostgresSQL to ensure that you are generating queries with SQLAlchemy that</span>
<span class="sd">take full advantage of any indexes you may have created for full text search.</span>

<span class="sd">FROM ONLY ...</span>
<span class="sd">------------------------</span>

<span class="sd">The dialect supports PostgreSQL&#39;s ONLY keyword for targeting only a particular</span>
<span class="sd">table in an inheritance hierarchy. This can be used to produce the</span>
<span class="sd">``SELECT ... FROM ONLY``, ``UPDATE ONLY ...``, and ``DELETE FROM ONLY ...``</span>
<span class="sd">syntaxes. It uses SQLAlchemy&#39;s hints mechanism::</span>

<span class="sd">    # SELECT ... FROM ONLY ...</span>
<span class="sd">    result = table.select().with_hint(table, &#39;ONLY&#39;, &#39;postgresql&#39;)</span>
<span class="sd">    print result.fetchall()</span>

<span class="sd">    # UPDATE ONLY ...</span>
<span class="sd">    table.update(values=dict(foo=&#39;bar&#39;)).with_hint(&#39;ONLY&#39;,</span>
<span class="sd">                                                   dialect_name=&#39;postgresql&#39;)</span>

<span class="sd">    # DELETE FROM ONLY ...</span>
<span class="sd">    table.delete().with_hint(&#39;ONLY&#39;, dialect_name=&#39;postgresql&#39;)</span>


<span class="sd">.. _postgresql_indexes:</span>

<span class="sd">PostgreSQL-Specific Index Options</span>
<span class="sd">---------------------------------</span>

<span class="sd">Several extensions to the :class:`.Index` construct are available, specific</span>
<span class="sd">to the PostgreSQL dialect.</span>

<span class="sd">.. _postgresql_partial_indexes:</span>

<span class="sd">Partial Indexes</span>
<span class="sd">^^^^^^^^^^^^^^^^</span>

<span class="sd">Partial indexes add criterion to the index definition so that the index is</span>
<span class="sd">applied to a subset of rows.   These can be specified on :class:`.Index`</span>
<span class="sd">using the ``postgresql_where`` keyword argument::</span>

<span class="sd">  Index(&#39;my_index&#39;, my_table.c.id, postgresql_where=my_table.c.value &gt; 10)</span>

<span class="sd">Operator Classes</span>
<span class="sd">^^^^^^^^^^^^^^^^^</span>

<span class="sd">PostgreSQL allows the specification of an *operator class* for each column of</span>
<span class="sd">an index (see</span>
<span class="sd">http://www.postgresql.org/docs/8.3/interactive/indexes-opclass.html).</span>
<span class="sd">The :class:`.Index` construct allows these to be specified via the</span>
<span class="sd">``postgresql_ops`` keyword argument::</span>

<span class="sd">    Index(</span>
<span class="sd">        &#39;my_index&#39;, my_table.c.id, my_table.c.data,</span>
<span class="sd">        postgresql_ops={</span>
<span class="sd">            &#39;data&#39;: &#39;text_pattern_ops&#39;,</span>
<span class="sd">            &#39;id&#39;: &#39;int4_ops&#39;</span>
<span class="sd">        })</span>

<span class="sd">Note that the keys in the ``postgresql_ops`` dictionary are the &quot;key&quot; name of</span>
<span class="sd">the :class:`.Column`, i.e. the name used to access it from the ``.c``</span>
<span class="sd">collection of :class:`.Table`, which can be configured to be different than</span>
<span class="sd">the actual name of the column as expressed in the database.</span>

<span class="sd">If ``postgresql_ops`` is to be used against a complex SQL expression such</span>
<span class="sd">as a function call, then to apply to the column it must be given a label</span>
<span class="sd">that is identified in the dictionary by name, e.g.::</span>

<span class="sd">    Index(</span>
<span class="sd">        &#39;my_index&#39;, my_table.c.id,</span>
<span class="sd">        func.lower(my_table.c.data).label(&#39;data_lower&#39;),</span>
<span class="sd">        postgresql_ops={</span>
<span class="sd">            &#39;data_lower&#39;: &#39;text_pattern_ops&#39;,</span>
<span class="sd">            &#39;id&#39;: &#39;int4_ops&#39;</span>
<span class="sd">        })</span>


<span class="sd">Index Types</span>
<span class="sd">^^^^^^^^^^^^</span>

<span class="sd">PostgreSQL provides several index types: B-Tree, Hash, GiST, and GIN, as well</span>
<span class="sd">as the ability for users to create their own (see</span>
<span class="sd">http://www.postgresql.org/docs/8.3/static/indexes-types.html). These can be</span>
<span class="sd">specified on :class:`.Index` using the ``postgresql_using`` keyword argument::</span>

<span class="sd">    Index(&#39;my_index&#39;, my_table.c.data, postgresql_using=&#39;gin&#39;)</span>

<span class="sd">The value passed to the keyword argument will be simply passed through to the</span>
<span class="sd">underlying CREATE INDEX command, so it *must* be a valid index type for your</span>
<span class="sd">version of PostgreSQL.</span>

<span class="sd">.. _postgresql_index_storage:</span>

<span class="sd">Index Storage Parameters</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^</span>

<span class="sd">PostgreSQL allows storage parameters to be set on indexes. The storage</span>
<span class="sd">parameters available depend on the index method used by the index. Storage</span>
<span class="sd">parameters can be specified on :class:`.Index` using the ``postgresql_with``</span>
<span class="sd">keyword argument::</span>

<span class="sd">    Index(&#39;my_index&#39;, my_table.c.data, postgresql_with={&quot;fillfactor&quot;: 50})</span>

<span class="sd">.. versionadded:: 1.0.6</span>

<span class="sd">PostgreSQL allows to define the tablespace in which to create the index.</span>
<span class="sd">The tablespace can be specified on :class:`.Index` using the</span>
<span class="sd">``postgresql_tablespace`` keyword argument::</span>

<span class="sd">    Index(&#39;my_index&#39;, my_table.c.data, postgresql_tablespace=&#39;my_tablespace&#39;)</span>

<span class="sd">.. versionadded:: 1.1</span>

<span class="sd">Note that the same option is available on :class:`.Table` as well.</span>

<span class="sd">.. _postgresql_index_concurrently:</span>

<span class="sd">Indexes with CONCURRENTLY</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^</span>

<span class="sd">The PostgreSQL index option CONCURRENTLY is supported by passing the</span>
<span class="sd">flag ``postgresql_concurrently`` to the :class:`.Index` construct::</span>

<span class="sd">    tbl = Table(&#39;testtbl&#39;, m, Column(&#39;data&#39;, Integer))</span>

<span class="sd">    idx1 = Index(&#39;test_idx1&#39;, tbl.c.data, postgresql_concurrently=True)</span>

<span class="sd">The above index construct will render DDL for CREATE INDEX, assuming</span>
<span class="sd">PostgreSQL 8.2 or higher is detected or for a connection-less dialect, as::</span>

<span class="sd">    CREATE INDEX CONCURRENTLY test_idx1 ON testtbl (data)</span>

<span class="sd">For DROP INDEX, assuming PostgreSQL 9.2 or higher is detected or for</span>
<span class="sd">a connection-less dialect, it will emit::</span>

<span class="sd">    DROP INDEX CONCURRENTLY test_idx1</span>

<span class="sd">.. versionadded:: 1.1 support for CONCURRENTLY on DROP INDEX.  The</span>
<span class="sd">   CONCURRENTLY keyword is now only emitted if a high enough version</span>
<span class="sd">   of PostgreSQL is detected on the connection (or for a connection-less</span>
<span class="sd">   dialect).</span>

<span class="sd">When using CONCURRENTLY, the Postgresql database requires that the statement</span>
<span class="sd">be invoked outside of a transaction block.   The Python DBAPI enforces that</span>
<span class="sd">even for a single statement, a transaction is present, so to use this</span>
<span class="sd">construct, the DBAPI&#39;s &quot;autocommit&quot; mode must be used::</span>

<span class="sd">    metadata = MetaData()</span>
<span class="sd">    table = Table(</span>
<span class="sd">        &quot;foo&quot;, metadata,</span>
<span class="sd">        Column(&quot;id&quot;, String))</span>
<span class="sd">    index = Index(</span>
<span class="sd">        &quot;foo_idx&quot;, table.c.id, postgresql_concurrently=True)</span>

<span class="sd">    with engine.connect() as conn:</span>
<span class="sd">        with conn.execution_options(isolation_level=&#39;AUTOCOMMIT&#39;):</span>
<span class="sd">            table.create(conn)</span>

<span class="sd">.. seealso::</span>

<span class="sd">    :ref:`postgresql_isolation_level`</span>

<span class="sd">.. _postgresql_index_reflection:</span>

<span class="sd">PostgreSQL Index Reflection</span>
<span class="sd">---------------------------</span>

<span class="sd">The PostgreSQL database creates a UNIQUE INDEX implicitly whenever the</span>
<span class="sd">UNIQUE CONSTRAINT construct is used.   When inspecting a table using</span>
<span class="sd">:class:`.Inspector`, the :meth:`.Inspector.get_indexes`</span>
<span class="sd">and the :meth:`.Inspector.get_unique_constraints` will report on these</span>
<span class="sd">two constructs distinctly; in the case of the index, the key</span>
<span class="sd">``duplicates_constraint`` will be present in the index entry if it is</span>
<span class="sd">detected as mirroring a constraint.   When performing reflection using</span>
<span class="sd">``Table(..., autoload=True)``, the UNIQUE INDEX is **not** returned</span>
<span class="sd">in :attr:`.Table.indexes` when it is detected as mirroring a</span>
<span class="sd">:class:`.UniqueConstraint` in the :attr:`.Table.constraints` collection.</span>

<span class="sd">.. versionchanged:: 1.0.0 - :class:`.Table` reflection now includes</span>
<span class="sd">   :class:`.UniqueConstraint` objects present in the :attr:`.Table.constraints`</span>
<span class="sd">   collection; the PostgreSQL backend will no longer include a &quot;mirrored&quot;</span>
<span class="sd">   :class:`.Index` construct in :attr:`.Table.indexes` if it is detected</span>
<span class="sd">   as corresponding to a unique constraint.</span>

<span class="sd">Special Reflection Options</span>
<span class="sd">--------------------------</span>

<span class="sd">The :class:`.Inspector` used for the PostgreSQL backend is an instance</span>
<span class="sd">of :class:`.PGInspector`, which offers additional methods::</span>

<span class="sd">    from sqlalchemy import create_engine, inspect</span>

<span class="sd">    engine = create_engine(&quot;postgresql+psycopg2://localhost/test&quot;)</span>
<span class="sd">    insp = inspect(engine)  # will be a PGInspector</span>

<span class="sd">    print(insp.get_enums())</span>

<span class="sd">.. autoclass:: PGInspector</span>
<span class="sd">    :members:</span>

<span class="sd">.. _postgresql_table_options:</span>

<span class="sd">PostgreSQL Table Options</span>
<span class="sd">-------------------------</span>

<span class="sd">Several options for CREATE TABLE are supported directly by the PostgreSQL</span>
<span class="sd">dialect in conjunction with the :class:`.Table` construct:</span>

<span class="sd">* ``TABLESPACE``::</span>

<span class="sd">    Table(&quot;some_table&quot;, metadata, ..., postgresql_tablespace=&#39;some_tablespace&#39;)</span>

<span class="sd">  The above option is also available on the :class:`.Index` construct.</span>

<span class="sd">* ``ON COMMIT``::</span>

<span class="sd">    Table(&quot;some_table&quot;, metadata, ..., postgresql_on_commit=&#39;PRESERVE ROWS&#39;)</span>

<span class="sd">* ``WITH OIDS``::</span>

<span class="sd">    Table(&quot;some_table&quot;, metadata, ..., postgresql_with_oids=True)</span>

<span class="sd">* ``WITHOUT OIDS``::</span>

<span class="sd">    Table(&quot;some_table&quot;, metadata, ..., postgresql_with_oids=False)</span>

<span class="sd">* ``INHERITS``::</span>

<span class="sd">    Table(&quot;some_table&quot;, metadata, ..., postgresql_inherits=&quot;some_supertable&quot;)</span>

<span class="sd">    Table(&quot;some_table&quot;, metadata, ..., postgresql_inherits=(&quot;t1&quot;, &quot;t2&quot;, ...))</span>

<span class="sd">.. versionadded:: 1.0.0</span>

<span class="sd">.. seealso::</span>

<span class="sd">    `PostgreSQL CREATE TABLE options</span>
<span class="sd">    &lt;http://www.postgresql.org/docs/current/static/sql-createtable.html&gt;`_</span>

<span class="sd">ARRAY Types</span>
<span class="sd">-----------</span>

<span class="sd">The PostgreSQL dialect supports arrays, both as multidimensional column types</span>
<span class="sd">as well as array literals:</span>

<span class="sd">* :class:`.postgresql.ARRAY` - ARRAY datatype</span>

<span class="sd">* :class:`.postgresql.array` - array literal</span>

<span class="sd">* :func:`.postgresql.array_agg` - ARRAY_AGG SQL function</span>

<span class="sd">* :class:`.postgresql.aggregate_order_by` - helper for PG&#39;s ORDER BY aggregate</span>
<span class="sd">  function syntax.</span>

<span class="sd">JSON Types</span>
<span class="sd">----------</span>

<span class="sd">The PostgreSQL dialect supports both JSON and JSONB datatypes, including</span>
<span class="sd">psycopg2&#39;s native support and support for all of PostgreSQL&#39;s special</span>
<span class="sd">operators:</span>

<span class="sd">* :class:`.postgresql.JSON`</span>

<span class="sd">* :class:`.postgresql.JSONB`</span>

<span class="sd">HSTORE Type</span>
<span class="sd">-----------</span>

<span class="sd">The PostgreSQL HSTORE type as well as hstore literals are supported:</span>

<span class="sd">* :class:`.postgresql.HSTORE` - HSTORE datatype</span>

<span class="sd">* :class:`.postgresql.hstore` - hstore literal</span>

<span class="sd">ENUM Types</span>
<span class="sd">----------</span>

<span class="sd">PostgreSQL has an independently creatable TYPE structure which is used</span>
<span class="sd">to implement an enumerated type.   This approach introduces significant</span>
<span class="sd">complexity on the SQLAlchemy side in terms of when this type should be</span>
<span class="sd">CREATED and DROPPED.   The type object is also an independently reflectable</span>
<span class="sd">entity.   The following sections should be consulted:</span>

<span class="sd">* :class:`.postgresql.ENUM` - DDL and typing support for ENUM.</span>

<span class="sd">* :meth:`.PGInspector.get_enums` - retrieve a listing of current ENUM types</span>

<span class="sd">* :meth:`.postgresql.ENUM.create` , :meth:`.postgresql.ENUM.drop` - individual</span>
<span class="sd">  CREATE and DROP commands for ENUM.</span>

<span class="sd">.. _postgresql_array_of_enum:</span>

<span class="sd">Using ENUM with ARRAY</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^</span>

<span class="sd">The combination of ENUM and ARRAY is not directly supported by backend</span>
<span class="sd">DBAPIs at this time.   In order to send and receive an ARRAY of ENUM,</span>
<span class="sd">use the following workaround type::</span>

<span class="sd">    class ArrayOfEnum(ARRAY):</span>

<span class="sd">        def bind_expression(self, bindvalue):</span>
<span class="sd">            return sa.cast(bindvalue, self)</span>

<span class="sd">        def result_processor(self, dialect, coltype):</span>
<span class="sd">            super_rp = super(ArrayOfEnum, self).result_processor(</span>
<span class="sd">                dialect, coltype)</span>

<span class="sd">            def handle_raw_string(value):</span>
<span class="sd">                inner = re.match(r&quot;^{(.*)}$&quot;, value).group(1)</span>
<span class="sd">                return inner.split(&quot;,&quot;) if inner else []</span>

<span class="sd">            def process(value):</span>
<span class="sd">                if value is None:</span>
<span class="sd">                    return None</span>
<span class="sd">                return super_rp(handle_raw_string(value))</span>
<span class="sd">            return process</span>

<span class="sd">E.g.::</span>

<span class="sd">    Table(</span>
<span class="sd">        &#39;mydata&#39;, metadata,</span>
<span class="sd">        Column(&#39;id&#39;, Integer, primary_key=True),</span>
<span class="sd">        Column(&#39;data&#39;, ArrayOfEnum(ENUM(&#39;a&#39;, &#39;b, &#39;c&#39;, name=&#39;myenum&#39;)))</span>

<span class="sd">    )</span>

<span class="sd">This type is not included as a built-in type as it would be incompatible</span>
<span class="sd">with a DBAPI that suddenly decides to support ARRAY of ENUM directly in</span>
<span class="sd">a new version.</span>

<span class="sd">.. _postgresql_array_of_json:</span>

<span class="sd">Using JSON/JSONB with ARRAY</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>

<span class="sd">Similar to using ENUM, for an ARRAY of JSON/JSONB we need to render the</span>
<span class="sd">appropriate CAST, however current psycopg2 drivers seem to handle the result</span>
<span class="sd">for ARRAY of JSON automatically, so the type is simpler::</span>


<span class="sd">    class CastingArray(ARRAY):</span>
<span class="sd">        def bind_expression(self, bindvalue):</span>
<span class="sd">            return sa.cast(bindvalue, self)</span>

<span class="sd">E.g.::</span>

<span class="sd">    Table(</span>
<span class="sd">        &#39;mydata&#39;, metadata,</span>
<span class="sd">        Column(&#39;id&#39;, Integer, primary_key=True),</span>
<span class="sd">        Column(&#39;data&#39;, CastingArray(JSONB))</span>
<span class="sd">    )</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>


<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="k">import</span> <span class="n">elements</span>
<span class="kn">from</span> <span class="nn">...</span> <span class="k">import</span> <span class="n">sql</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">...engine</span> <span class="k">import</span> <span class="n">default</span><span class="p">,</span> <span class="n">reflection</span>
<span class="kn">from</span> <span class="nn">...sql</span> <span class="k">import</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">expression</span>
<span class="kn">from</span> <span class="nn">...sql</span> <span class="k">import</span> <span class="n">sqltypes</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">uuid</span> <span class="k">import</span> <span class="n">UUID</span> <span class="k">as</span> <span class="n">_python_UUID</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_python_UUID</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="k">import</span> <span class="n">INTEGER</span><span class="p">,</span> <span class="n">BIGINT</span><span class="p">,</span> <span class="n">SMALLINT</span><span class="p">,</span> <span class="n">VARCHAR</span><span class="p">,</span> \
    <span class="n">CHAR</span><span class="p">,</span> <span class="n">TEXT</span><span class="p">,</span> <span class="n">FLOAT</span><span class="p">,</span> <span class="n">NUMERIC</span><span class="p">,</span> \
    <span class="n">DATE</span><span class="p">,</span> <span class="n">BOOLEAN</span><span class="p">,</span> <span class="n">REAL</span>

<span class="n">AUTOCOMMIT_REGEXP</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;\s*(?:UPDATE|INSERT|CREATE|DELETE|DROP|ALTER|GRANT|REVOKE|&#39;</span>
    <span class="s1">&#39;IMPORT FOREIGN SCHEMA|REFRESH MATERIALIZED VIEW|TRUNCATE)&#39;</span><span class="p">,</span>
    <span class="n">re</span><span class="o">.</span><span class="n">I</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>

<span class="n">RESERVED_WORDS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;analyse&quot;</span><span class="p">,</span> <span class="s2">&quot;analyze&quot;</span><span class="p">,</span> <span class="s2">&quot;and&quot;</span><span class="p">,</span> <span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="s2">&quot;as&quot;</span><span class="p">,</span> <span class="s2">&quot;asc&quot;</span><span class="p">,</span>
     <span class="s2">&quot;asymmetric&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="s2">&quot;case&quot;</span><span class="p">,</span> <span class="s2">&quot;cast&quot;</span><span class="p">,</span> <span class="s2">&quot;check&quot;</span><span class="p">,</span> <span class="s2">&quot;collate&quot;</span><span class="p">,</span> <span class="s2">&quot;column&quot;</span><span class="p">,</span>
     <span class="s2">&quot;constraint&quot;</span><span class="p">,</span> <span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="s2">&quot;current_catalog&quot;</span><span class="p">,</span> <span class="s2">&quot;current_date&quot;</span><span class="p">,</span>
     <span class="s2">&quot;current_role&quot;</span><span class="p">,</span> <span class="s2">&quot;current_time&quot;</span><span class="p">,</span> <span class="s2">&quot;current_timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;current_user&quot;</span><span class="p">,</span>
     <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="s2">&quot;deferrable&quot;</span><span class="p">,</span> <span class="s2">&quot;desc&quot;</span><span class="p">,</span> <span class="s2">&quot;distinct&quot;</span><span class="p">,</span> <span class="s2">&quot;do&quot;</span><span class="p">,</span> <span class="s2">&quot;else&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
     <span class="s2">&quot;except&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;fetch&quot;</span><span class="p">,</span> <span class="s2">&quot;for&quot;</span><span class="p">,</span> <span class="s2">&quot;foreign&quot;</span><span class="p">,</span> <span class="s2">&quot;from&quot;</span><span class="p">,</span> <span class="s2">&quot;grant&quot;</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">,</span>
     <span class="s2">&quot;having&quot;</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="s2">&quot;initially&quot;</span><span class="p">,</span> <span class="s2">&quot;intersect&quot;</span><span class="p">,</span> <span class="s2">&quot;into&quot;</span><span class="p">,</span> <span class="s2">&quot;leading&quot;</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">,</span>
     <span class="s2">&quot;localtime&quot;</span><span class="p">,</span> <span class="s2">&quot;localtimestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">,</span> <span class="s2">&quot;not&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="s2">&quot;of&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span>
     <span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="s2">&quot;old&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="s2">&quot;only&quot;</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="s2">&quot;placing&quot;</span><span class="p">,</span> <span class="s2">&quot;primary&quot;</span><span class="p">,</span>
     <span class="s2">&quot;references&quot;</span><span class="p">,</span> <span class="s2">&quot;returning&quot;</span><span class="p">,</span> <span class="s2">&quot;select&quot;</span><span class="p">,</span> <span class="s2">&quot;session_user&quot;</span><span class="p">,</span> <span class="s2">&quot;some&quot;</span><span class="p">,</span> <span class="s2">&quot;symmetric&quot;</span><span class="p">,</span>
     <span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="s2">&quot;then&quot;</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">,</span> <span class="s2">&quot;trailing&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;union&quot;</span><span class="p">,</span> <span class="s2">&quot;unique&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
     <span class="s2">&quot;using&quot;</span><span class="p">,</span> <span class="s2">&quot;variadic&quot;</span><span class="p">,</span> <span class="s2">&quot;when&quot;</span><span class="p">,</span> <span class="s2">&quot;where&quot;</span><span class="p">,</span> <span class="s2">&quot;window&quot;</span><span class="p">,</span> <span class="s2">&quot;with&quot;</span><span class="p">,</span> <span class="s2">&quot;authorization&quot;</span><span class="p">,</span>
     <span class="s2">&quot;between&quot;</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="s2">&quot;cross&quot;</span><span class="p">,</span> <span class="s2">&quot;current_schema&quot;</span><span class="p">,</span> <span class="s2">&quot;freeze&quot;</span><span class="p">,</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span>
     <span class="s2">&quot;ilike&quot;</span><span class="p">,</span> <span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="s2">&quot;is&quot;</span><span class="p">,</span> <span class="s2">&quot;isnull&quot;</span><span class="p">,</span> <span class="s2">&quot;join&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;like&quot;</span><span class="p">,</span> <span class="s2">&quot;natural&quot;</span><span class="p">,</span>
     <span class="s2">&quot;notnull&quot;</span><span class="p">,</span> <span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="s2">&quot;over&quot;</span><span class="p">,</span> <span class="s2">&quot;overlaps&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;similar&quot;</span><span class="p">,</span> <span class="s2">&quot;verbose&quot;</span>
     <span class="p">])</span>

<span class="n">_DECIMAL_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1231</span><span class="p">,</span> <span class="mi">1700</span><span class="p">)</span>
<span class="n">_FLOAT_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="mi">700</span><span class="p">,</span> <span class="mi">701</span><span class="p">,</span> <span class="mi">1021</span><span class="p">,</span> <span class="mi">1022</span><span class="p">)</span>
<span class="n">_INT_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">1005</span><span class="p">,</span> <span class="mi">1007</span><span class="p">,</span> <span class="mi">1016</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BYTEA</span><span class="p">(</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">LargeBinary</span><span class="p">):</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s1">&#39;BYTEA&#39;</span>


<span class="k">class</span> <span class="nc">DOUBLE_PRECISION</span><span class="p">(</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Float</span><span class="p">):</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s1">&#39;DOUBLE_PRECISION&#39;</span>


<span class="k">class</span> <span class="nc">INET</span><span class="p">(</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">TypeEngine</span><span class="p">):</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">&quot;INET&quot;</span>
<span class="n">PGInet</span> <span class="o">=</span> <span class="n">INET</span>


<span class="k">class</span> <span class="nc">CIDR</span><span class="p">(</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">TypeEngine</span><span class="p">):</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">&quot;CIDR&quot;</span>
<span class="n">PGCidr</span> <span class="o">=</span> <span class="n">CIDR</span>


<span class="k">class</span> <span class="nc">MACADDR</span><span class="p">(</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">TypeEngine</span><span class="p">):</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">&quot;MACADDR&quot;</span>
<span class="n">PGMacAddr</span> <span class="o">=</span> <span class="n">MACADDR</span>


<span class="k">class</span> <span class="nc">MONEY</span><span class="p">(</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">TypeEngine</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Provide the PostgreSQL MONEY type.</span>

<span class="sd">    .. versionadded:: 1.2</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">&quot;MONEY&quot;</span>


<span class="k">class</span> <span class="nc">OID</span><span class="p">(</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">TypeEngine</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Provide the PostgreSQL OID type.</span>

<span class="sd">    .. versionadded:: 0.9.5</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">&quot;OID&quot;</span>


<span class="k">class</span> <span class="nc">TIMESTAMP</span><span class="p">(</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">TIMESTAMP</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timezone</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TIMESTAMP</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="n">timezone</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span>


<span class="k">class</span> <span class="nc">TIME</span><span class="p">(</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">TIME</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timezone</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TIME</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="n">timezone</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span>


<span class="k">class</span> <span class="nc">INTERVAL</span><span class="p">(</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">NativeForEmulated</span><span class="p">,</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">_AbstractInterval</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;PostgreSQL INTERVAL type.</span>

<span class="sd">    The INTERVAL type may not be supported on all DBAPIs.</span>
<span class="sd">    It is known to work on psycopg2 and not pg8000 or zxjdbc.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s1">&#39;INTERVAL&#39;</span>
    <span class="n">native</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct an INTERVAL.</span>

<span class="sd">        :param precision: optional integer precision value</span>
<span class="sd">        :param fields: string fields specifier.  allows storage of fields</span>
<span class="sd">         to be limited, such as ``&quot;YEAR&quot;``, ``&quot;MONTH&quot;``, ``&quot;DAY TO HOUR&quot;``,</span>
<span class="sd">         etc.</span>

<span class="sd">         .. versionadded:: 1.2</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">adapt_emulated_to_native</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">INTERVAL</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="n">interval</span><span class="o">.</span><span class="n">second_precision</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_type_affinity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">Interval</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">python_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span>

<span class="n">PGInterval</span> <span class="o">=</span> <span class="n">INTERVAL</span>


<span class="k">class</span> <span class="nc">BIT</span><span class="p">(</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">TypeEngine</span><span class="p">):</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s1">&#39;BIT&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">varying</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">varying</span><span class="p">:</span>
            <span class="c1"># BIT without VARYING defaults to length 1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="ow">or</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># but BIT VARYING can be unlimited-length, so no default</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">varying</span> <span class="o">=</span> <span class="n">varying</span>

<span class="n">PGBit</span> <span class="o">=</span> <span class="n">BIT</span>


<span class="k">class</span> <span class="nc">UUID</span><span class="p">(</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">TypeEngine</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;PostgreSQL UUID type.</span>

<span class="sd">    Represents the UUID column type, interpreting</span>
<span class="sd">    data either as natively returned by the DBAPI</span>
<span class="sd">    or as Python uuid objects.</span>

<span class="sd">    The UUID type may not be supported on all DBAPIs.</span>
<span class="sd">    It is known to work on psycopg2 and not pg8000.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s1">&#39;UUID&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_uuid</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a UUID type.</span>


<span class="sd">        :param as_uuid=False: if True, values will be interpreted</span>
<span class="sd">         as Python uuid objects, converting to/from string via the</span>
<span class="sd">         DBAPI.</span>

<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">as_uuid</span> <span class="ow">and</span> <span class="n">_python_UUID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;This version of Python does not support &quot;</span>
                <span class="s2">&quot;the native UUID type.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">as_uuid</span> <span class="o">=</span> <span class="n">as_uuid</span>

    <span class="k">def</span> <span class="nf">bind_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_uuid</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">process</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">result_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">coltype</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_uuid</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">_python_UUID</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">process</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<span class="n">PGUuid</span> <span class="o">=</span> <span class="n">UUID</span>


<span class="k">class</span> <span class="nc">TSVECTOR</span><span class="p">(</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">TypeEngine</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;The :class:`.postgresql.TSVECTOR` type implements the PostgreSQL</span>
<span class="sd">    text search type TSVECTOR.</span>

<span class="sd">    It can be used to do full text queries on natural language</span>
<span class="sd">    documents.</span>

<span class="sd">    .. versionadded:: 0.9.0</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :ref:`postgresql_match`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s1">&#39;TSVECTOR&#39;</span>


<span class="k">class</span> <span class="nc">ENUM</span><span class="p">(</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">NativeForEmulated</span><span class="p">,</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;PostgreSQL ENUM type.</span>

<span class="sd">    This is a subclass of :class:`.types.Enum` which includes</span>
<span class="sd">    support for PG&#39;s ``CREATE TYPE`` and ``DROP TYPE``.</span>

<span class="sd">    When the builtin type :class:`.types.Enum` is used and the</span>
<span class="sd">    :paramref:`.Enum.native_enum` flag is left at its default of</span>
<span class="sd">    True, the PostgreSQL backend will use a :class:`.postgresql.ENUM`</span>
<span class="sd">    type as the implementation, so the special create/drop rules</span>
<span class="sd">    will be used.</span>

<span class="sd">    The create/drop behavior of ENUM is necessarily intricate, due to the</span>
<span class="sd">    awkward relationship the ENUM type has in relationship to the</span>
<span class="sd">    parent table, in that it may be &quot;owned&quot; by just a single table, or</span>
<span class="sd">    may be shared among many tables.</span>

<span class="sd">    When using :class:`.types.Enum` or :class:`.postgresql.ENUM`</span>
<span class="sd">    in an &quot;inline&quot; fashion, the ``CREATE TYPE`` and ``DROP TYPE`` is emitted</span>
<span class="sd">    corresponding to when the :meth:`.Table.create` and :meth:`.Table.drop`</span>
<span class="sd">    methods are called::</span>

<span class="sd">        table = Table(&#39;sometable&#39;, metadata,</span>
<span class="sd">            Column(&#39;some_enum&#39;, ENUM(&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, name=&#39;myenum&#39;))</span>
<span class="sd">        )</span>

<span class="sd">        table.create(engine)  # will emit CREATE ENUM and CREATE TABLE</span>
<span class="sd">        table.drop(engine)  # will emit DROP TABLE and DROP ENUM</span>

<span class="sd">    To use a common enumerated type between multiple tables, the best</span>
<span class="sd">    practice is to declare the :class:`.types.Enum` or</span>
<span class="sd">    :class:`.postgresql.ENUM` independently, and associate it with the</span>
<span class="sd">    :class:`.MetaData` object itself::</span>

<span class="sd">        my_enum = ENUM(&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, name=&#39;myenum&#39;, metadata=metadata)</span>

<span class="sd">        t1 = Table(&#39;sometable_one&#39;, metadata,</span>
<span class="sd">            Column(&#39;some_enum&#39;, myenum)</span>
<span class="sd">        )</span>

<span class="sd">        t2 = Table(&#39;sometable_two&#39;, metadata,</span>
<span class="sd">            Column(&#39;some_enum&#39;, myenum)</span>
<span class="sd">        )</span>

<span class="sd">    When this pattern is used, care must still be taken at the level</span>
<span class="sd">    of individual table creates.  Emitting CREATE TABLE without also</span>
<span class="sd">    specifying ``checkfirst=True`` will still cause issues::</span>

<span class="sd">        t1.create(engine) # will fail: no such type &#39;myenum&#39;</span>

<span class="sd">    If we specify ``checkfirst=True``, the individual table-level create</span>
<span class="sd">    operation will check for the ``ENUM`` and create if not exists::</span>

<span class="sd">        # will check if enum exists, and emit CREATE TYPE if not</span>
<span class="sd">        t1.create(engine, checkfirst=True)</span>

<span class="sd">    When using a metadata-level ENUM type, the type will always be created</span>
<span class="sd">    and dropped if either the metadata-wide create/drop is called::</span>

<span class="sd">        metadata.create_all(engine)  # will emit CREATE TYPE</span>
<span class="sd">        metadata.drop_all(engine)  # will emit DROP TYPE</span>

<span class="sd">    The type can also be created and dropped directly::</span>

<span class="sd">        my_enum.create(engine)</span>
<span class="sd">        my_enum.drop(engine)</span>

<span class="sd">    .. versionchanged:: 1.0.0 The PostgreSQL :class:`.postgresql.ENUM` type</span>
<span class="sd">       now behaves more strictly with regards to CREATE/DROP.  A metadata-level</span>
<span class="sd">       ENUM type will only be created and dropped at the metadata level,</span>
<span class="sd">       not the table level, with the exception of</span>
<span class="sd">       ``table.create(checkfirst=True)``.</span>
<span class="sd">       The ``table.drop()`` call will now emit a DROP TYPE for a table-level</span>
<span class="sd">       enumerated type.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">native_enum</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">enums</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct an :class:`~.postgresql.ENUM`.</span>

<span class="sd">        Arguments are the same as that of</span>
<span class="sd">        :class:`.types.Enum`, but also including</span>
<span class="sd">        the following parameters.</span>

<span class="sd">        :param create_type: Defaults to True.</span>
<span class="sd">         Indicates that ``CREATE TYPE`` should be</span>
<span class="sd">         emitted, after optionally checking for the</span>
<span class="sd">         presence of the type, when the parent</span>
<span class="sd">         table is being created; and additionally</span>
<span class="sd">         that ``DROP TYPE`` is called when the table</span>
<span class="sd">         is dropped.    When ``False``, no check</span>
<span class="sd">         will be performed and no ``CREATE TYPE``</span>
<span class="sd">         or ``DROP TYPE`` is emitted, unless</span>
<span class="sd">         :meth:`~.postgresql.ENUM.create`</span>
<span class="sd">         or :meth:`~.postgresql.ENUM.drop`</span>
<span class="sd">         are called directly.</span>
<span class="sd">         Setting to ``False`` is helpful</span>
<span class="sd">         when invoking a creation scheme to a SQL file</span>
<span class="sd">         without access to the actual database -</span>
<span class="sd">         the :meth:`~.postgresql.ENUM.create` and</span>
<span class="sd">         :meth:`~.postgresql.ENUM.drop` methods can</span>
<span class="sd">         be used to emit SQL to a target bind.</span>

<span class="sd">         .. versionadded:: 0.7.4</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_type</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;create_type&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ENUM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">enums</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">adapt_emulated_to_native</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">impl</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Produce a Postgresql native :class:`.postgresql.ENUM` from plain</span>
<span class="sd">        :class:`.Enum`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;validate_strings&quot;</span><span class="p">,</span> <span class="n">impl</span><span class="o">.</span><span class="n">validate_strings</span><span class="p">)</span>
        <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">impl</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;schema&#39;</span><span class="p">,</span> <span class="n">impl</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;inherit_schema&#39;</span><span class="p">,</span> <span class="n">impl</span><span class="o">.</span><span class="n">inherit_schema</span><span class="p">)</span>
        <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="n">impl</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
        <span class="n">kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;_create_events&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Emit ``CREATE TYPE`` for this</span>
<span class="sd">        :class:`~.postgresql.ENUM`.</span>

<span class="sd">        If the underlying dialect does not support</span>
<span class="sd">        PostgreSQL CREATE TYPE, no action is taken.</span>

<span class="sd">        :param bind: a connectable :class:`.Engine`,</span>
<span class="sd">         :class:`.Connection`, or similar object to emit</span>
<span class="sd">         SQL.</span>
<span class="sd">        :param checkfirst: if ``True``, a query against</span>
<span class="sd">         the PG catalog will be first performed to see</span>
<span class="sd">         if the type does not exist already before</span>
<span class="sd">         creating.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bind</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">supports_native_enum</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">checkfirst</span> <span class="ow">or</span> \
                <span class="ow">not</span> <span class="n">bind</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">has_type</span><span class="p">(</span>
                    <span class="n">bind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">):</span>
            <span class="n">bind</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">CreateEnumType</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Emit ``DROP TYPE`` for this</span>
<span class="sd">        :class:`~.postgresql.ENUM`.</span>

<span class="sd">        If the underlying dialect does not support</span>
<span class="sd">        PostgreSQL DROP TYPE, no action is taken.</span>

<span class="sd">        :param bind: a connectable :class:`.Engine`,</span>
<span class="sd">         :class:`.Connection`, or similar object to emit</span>
<span class="sd">         SQL.</span>
<span class="sd">        :param checkfirst: if ``True``, a query against</span>
<span class="sd">         the PG catalog will be first performed to see</span>
<span class="sd">         if the type actually exists before dropping.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bind</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">supports_native_enum</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">checkfirst</span> <span class="ow">or</span> \
                <span class="n">bind</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">has_type</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">):</span>
            <span class="n">bind</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">DropEnumType</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_for_name_in_memos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkfirst</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Look in the &#39;ddl runner&#39; for &#39;memos&#39;, then</span>
<span class="sd">        note our name in that collection.</span>

<span class="sd">        This to ensure a particular named enum is operated</span>
<span class="sd">        upon only once within any kind of create/drop</span>
<span class="sd">        sequence without relying upon &quot;checkfirst&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;_ddl_runner&#39;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="n">ddl_runner</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;_ddl_runner&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;_pg_enums&#39;</span> <span class="ow">in</span> <span class="n">ddl_runner</span><span class="o">.</span><span class="n">memo</span><span class="p">:</span>
                <span class="n">pg_enums</span> <span class="o">=</span> <span class="n">ddl_runner</span><span class="o">.</span><span class="n">memo</span><span class="p">[</span><span class="s1">&#39;_pg_enums&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pg_enums</span> <span class="o">=</span> <span class="n">ddl_runner</span><span class="o">.</span><span class="n">memo</span><span class="p">[</span><span class="s1">&#39;_pg_enums&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">present</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">pg_enums</span>
            <span class="n">pg_enums</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">present</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_on_table_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">checkfirst</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_is_metadata_operation&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_name_in_memos</span><span class="p">(</span><span class="n">checkfirst</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">bind</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_table_drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">and</span> \
            <span class="ow">not</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_is_metadata_operation&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_name_in_memos</span><span class="p">(</span><span class="n">checkfirst</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">bind</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_metadata_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_name_in_memos</span><span class="p">(</span><span class="n">checkfirst</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">bind</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_metadata_drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_name_in_memos</span><span class="p">(</span><span class="n">checkfirst</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">bind</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">)</span>

<span class="n">colspecs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">sqltypes</span><span class="o">.</span><span class="n">Interval</span><span class="p">:</span> <span class="n">INTERVAL</span><span class="p">,</span>
    <span class="n">sqltypes</span><span class="o">.</span><span class="n">Enum</span><span class="p">:</span> <span class="n">ENUM</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">ischema_names</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="n">INTEGER</span><span class="p">,</span>
    <span class="s1">&#39;bigint&#39;</span><span class="p">:</span> <span class="n">BIGINT</span><span class="p">,</span>
    <span class="s1">&#39;smallint&#39;</span><span class="p">:</span> <span class="n">SMALLINT</span><span class="p">,</span>
    <span class="s1">&#39;character varying&#39;</span><span class="p">:</span> <span class="n">VARCHAR</span><span class="p">,</span>
    <span class="s1">&#39;character&#39;</span><span class="p">:</span> <span class="n">CHAR</span><span class="p">,</span>
    <span class="s1">&#39;&quot;char&quot;&#39;</span><span class="p">:</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
    <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">TEXT</span><span class="p">,</span>
    <span class="s1">&#39;numeric&#39;</span><span class="p">:</span> <span class="n">NUMERIC</span><span class="p">,</span>
    <span class="s1">&#39;float&#39;</span><span class="p">:</span> <span class="n">FLOAT</span><span class="p">,</span>
    <span class="s1">&#39;real&#39;</span><span class="p">:</span> <span class="n">REAL</span><span class="p">,</span>
    <span class="s1">&#39;inet&#39;</span><span class="p">:</span> <span class="n">INET</span><span class="p">,</span>
    <span class="s1">&#39;cidr&#39;</span><span class="p">:</span> <span class="n">CIDR</span><span class="p">,</span>
    <span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span>
    <span class="s1">&#39;bit&#39;</span><span class="p">:</span> <span class="n">BIT</span><span class="p">,</span>
    <span class="s1">&#39;bit varying&#39;</span><span class="p">:</span> <span class="n">BIT</span><span class="p">,</span>
    <span class="s1">&#39;macaddr&#39;</span><span class="p">:</span> <span class="n">MACADDR</span><span class="p">,</span>
    <span class="s1">&#39;money&#39;</span><span class="p">:</span> <span class="n">MONEY</span><span class="p">,</span>
    <span class="s1">&#39;oid&#39;</span><span class="p">:</span> <span class="n">OID</span><span class="p">,</span>
    <span class="s1">&#39;double precision&#39;</span><span class="p">:</span> <span class="n">DOUBLE_PRECISION</span><span class="p">,</span>
    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">TIMESTAMP</span><span class="p">,</span>
    <span class="s1">&#39;timestamp with time zone&#39;</span><span class="p">:</span> <span class="n">TIMESTAMP</span><span class="p">,</span>
    <span class="s1">&#39;timestamp without time zone&#39;</span><span class="p">:</span> <span class="n">TIMESTAMP</span><span class="p">,</span>
    <span class="s1">&#39;time with time zone&#39;</span><span class="p">:</span> <span class="n">TIME</span><span class="p">,</span>
    <span class="s1">&#39;time without time zone&#39;</span><span class="p">:</span> <span class="n">TIME</span><span class="p">,</span>
    <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">DATE</span><span class="p">,</span>
    <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">TIME</span><span class="p">,</span>
    <span class="s1">&#39;bytea&#39;</span><span class="p">:</span> <span class="n">BYTEA</span><span class="p">,</span>
    <span class="s1">&#39;boolean&#39;</span><span class="p">:</span> <span class="n">BOOLEAN</span><span class="p">,</span>
    <span class="s1">&#39;interval&#39;</span><span class="p">:</span> <span class="n">INTERVAL</span><span class="p">,</span>
    <span class="s1">&#39;tsvector&#39;</span><span class="p">:</span> <span class="n">TSVECTOR</span>
<span class="p">}</span>


<span class="k">class</span> <span class="nc">PGCompiler</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">SQLCompiler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">visit_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;ARRAY[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_clauselist</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_json_getitem_op_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;eager_grouping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_generic_binary</span><span class="p">(</span>
            <span class="n">binary</span><span class="p">,</span> <span class="s2">&quot; -&gt; &quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_json_path_getitem_op_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;eager_grouping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_generic_binary</span><span class="p">(</span>
            <span class="n">binary</span><span class="p">,</span> <span class="s2">&quot; #&gt; &quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_getitem_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_aggregate_order_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> ORDER BY </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">order_by</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_match_op_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;postgresql_regconfig&quot;</span> <span class="ow">in</span> <span class="n">binary</span><span class="o">.</span><span class="n">modifiers</span><span class="p">:</span>
            <span class="n">regconfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_literal_value</span><span class="p">(</span>
                <span class="n">binary</span><span class="o">.</span><span class="n">modifiers</span><span class="p">[</span><span class="s1">&#39;postgresql_regconfig&#39;</span><span class="p">],</span>
                <span class="n">sqltypes</span><span class="o">.</span><span class="n">STRINGTYPE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">regconfig</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> @@ to_tsquery(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">),</span>
                    <span class="n">regconfig</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> @@ to_tsquery(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_ilike_op_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">escape</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">modifiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;escape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> ILIKE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">),</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">))</span> \
            <span class="o">+</span> <span class="p">(</span>
                <span class="s1">&#39; ESCAPE &#39;</span> <span class="o">+</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">render_literal_value</span><span class="p">(</span><span class="n">escape</span><span class="p">,</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">STRINGTYPE</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">escape</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_notilike_op_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">escape</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">modifiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;escape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> NOT ILIKE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">),</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">))</span> \
            <span class="o">+</span> <span class="p">(</span>
                <span class="s1">&#39; ESCAPE &#39;</span> <span class="o">+</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">render_literal_value</span><span class="p">(</span><span class="n">escape</span><span class="p">,</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">STRINGTYPE</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">escape</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_literal_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">PGCompiler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">render_literal_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">_backslash_escapes</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">visit_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;nextval(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">preparer</span><span class="o">.</span><span class="n">format_sequence</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">limit_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">_limit_clause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="se">\n</span><span class="s2"> LIMIT &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">_limit_clause</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">_offset_clause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">_limit_clause</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="se">\n</span><span class="s2"> LIMIT ALL&quot;</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot; OFFSET &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">_offset_clause</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">format_from_hint_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqltext</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">hint</span><span class="p">,</span> <span class="n">iscrud</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">hint</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;ONLY&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">CompileError</span><span class="p">(</span><span class="s2">&quot;Unrecognized hint: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">hint</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;ONLY &quot;</span> <span class="o">+</span> <span class="n">sqltext</span>

    <span class="k">def</span> <span class="nf">get_select_precolumns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">_distinct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">_distinct</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;DISTINCT &quot;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">_distinct</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">return</span> <span class="s2">&quot;DISTINCT ON (&quot;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">select</span><span class="o">.</span><span class="n">_distinct</span><span class="p">]</span>
                <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;) &quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;DISTINCT ON (&quot;</span> <span class="o">+</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">_distinct</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;) &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">for_update_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">_for_update_arg</span><span class="o">.</span><span class="n">read</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">_for_update_arg</span><span class="o">.</span><span class="n">key_share</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="s2">&quot; FOR KEY SHARE&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="s2">&quot; FOR SHARE&quot;</span>
        <span class="k">elif</span> <span class="n">select</span><span class="o">.</span><span class="n">_for_update_arg</span><span class="o">.</span><span class="n">key_share</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="s2">&quot; FOR NO KEY UPDATE&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="s2">&quot; FOR UPDATE&quot;</span>

        <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">_for_update_arg</span><span class="o">.</span><span class="n">of</span><span class="p">:</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedSet</span><span class="p">(</span>
                <span class="n">c</span><span class="o">.</span><span class="n">table</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnClause</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">select</span><span class="o">.</span><span class="n">_for_update_arg</span><span class="o">.</span><span class="n">of</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">+=</span> <span class="s2">&quot; OF &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">ashint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_schema</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">_for_update_arg</span><span class="o">.</span><span class="n">nowait</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">+=</span> <span class="s2">&quot; NOWAIT&quot;</span>
        <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">_for_update_arg</span><span class="o">.</span><span class="n">skip_locked</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">+=</span> <span class="s2">&quot; SKIP LOCKED&quot;</span>

        <span class="k">return</span> <span class="n">tmp</span>

    <span class="k">def</span> <span class="nf">returning_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">returning_cols</span><span class="p">):</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_label_select_column</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">expression</span><span class="o">.</span><span class="n">_select_iterables</span><span class="p">(</span><span class="n">returning_cols</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="s1">&#39;RETURNING &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_substring_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">clauses</span><span class="o">.</span><span class="n">clauses</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">clauses</span><span class="o">.</span><span class="n">clauses</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">clauses</span><span class="o">.</span><span class="n">clauses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">clauses</span><span class="o">.</span><span class="n">clauses</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;SUBSTRING(</span><span class="si">%s</span><span class="s2"> FROM </span><span class="si">%s</span><span class="s2"> FOR </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;SUBSTRING(</span><span class="si">%s</span><span class="s2"> FROM </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_conflict_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clause</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">clause</span><span class="o">.</span><span class="n">constraint_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_text</span> <span class="o">=</span> <span class="s1">&#39;ON CONSTRAINT </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">clause</span><span class="o">.</span><span class="n">constraint_target</span>
        <span class="k">elif</span> <span class="n">clause</span><span class="o">.</span><span class="n">inferred_target_elements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_text</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preparer</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                 <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span>
                 <span class="k">else</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">include_table</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_schema</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clause</span><span class="o">.</span><span class="n">inferred_target_elements</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">clause</span><span class="o">.</span><span class="n">inferred_target_whereclause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">target_text</span> <span class="o">+=</span> <span class="s1">&#39; WHERE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
                        <span class="n">clause</span><span class="o">.</span><span class="n">inferred_target_whereclause</span><span class="p">,</span>
                        <span class="n">include_table</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">use_schema</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">return</span> <span class="n">target_text</span>

    <span class="k">def</span> <span class="nf">visit_on_conflict_do_nothing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_conflict</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>

        <span class="n">target_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_conflict_target</span><span class="p">(</span><span class="n">on_conflict</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">target_text</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;ON CONFLICT </span><span class="si">%s</span><span class="s2"> DO NOTHING&quot;</span> <span class="o">%</span> <span class="n">target_text</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;ON CONFLICT DO NOTHING&quot;</span>

    <span class="k">def</span> <span class="nf">visit_on_conflict_do_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_conflict</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>

        <span class="n">clause</span> <span class="o">=</span> <span class="n">on_conflict</span>

        <span class="n">target_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_conflict_target</span><span class="p">(</span><span class="n">on_conflict</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="n">action_set_ops</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">set_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">clause</span><span class="o">.</span><span class="n">update_values_to_set</span><span class="p">)</span>
        <span class="c1"># create a list of column assignment clauses as tuples</span>

        <span class="n">insert_statement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;selectable&#39;</span><span class="p">]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">insert_statement</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">c</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">col_key</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">key</span>
            <span class="k">if</span> <span class="n">col_key</span> <span class="ow">in</span> <span class="n">set_parameters</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">set_parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">col_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">elements</span><span class="o">.</span><span class="n">_is_literal</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="n">BindParameter</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">type</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">elements</span><span class="o">.</span><span class="n">BindParameter</span><span class="p">)</span> <span class="ow">and</span> \
                            <span class="n">value</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">_isnull</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
                        <span class="n">value</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">type</span>
                <span class="n">value_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">self_group</span><span class="p">(),</span> <span class="n">use_schema</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">key_text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">preparer</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">col_key</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">action_set_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key_text</span><span class="p">,</span> <span class="n">value_text</span><span class="p">))</span>

        <span class="c1"># check for names that don&#39;t match columns</span>
        <span class="k">if</span> <span class="n">set_parameters</span><span class="p">:</span>
            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Additional column names not matching &quot;</span>
                <span class="s2">&quot;any column keys in table &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">set_parameters</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">set_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">key_text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">preparer</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span>
                    <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">use_schema</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">value_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
                    <span class="n">elements</span><span class="o">.</span><span class="n">_literal_as_binds</span><span class="p">(</span><span class="n">v</span><span class="p">),</span>
                    <span class="n">use_schema</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="n">action_set_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key_text</span><span class="p">,</span> <span class="n">value_text</span><span class="p">))</span>

        <span class="n">action_text</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">action_set_ops</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clause</span><span class="o">.</span><span class="n">update_whereclause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">action_text</span> <span class="o">+=</span> <span class="s1">&#39; WHERE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
                    <span class="n">clause</span><span class="o">.</span><span class="n">update_whereclause</span><span class="p">,</span>
                    <span class="n">include_table</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">use_schema</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;ON CONFLICT </span><span class="si">%s</span><span class="s1"> DO UPDATE SET </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_text</span><span class="p">,</span> <span class="n">action_text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_from_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_stmt</span><span class="p">,</span>
                           <span class="n">from_table</span><span class="p">,</span> <span class="n">extra_froms</span><span class="p">,</span>
                           <span class="n">from_hints</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;FROM &quot;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">t</span><span class="o">.</span><span class="n">_compiler_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asfrom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">fromhints</span><span class="o">=</span><span class="n">from_hints</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">extra_froms</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete_extra_from_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delete_stmt</span><span class="p">,</span> <span class="n">from_table</span><span class="p">,</span>
                           <span class="n">extra_froms</span><span class="p">,</span> <span class="n">from_hints</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Render the DELETE .. USING clause specific to PostgresSQL.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;USING &quot;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">t</span><span class="o">.</span><span class="n">_compiler_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asfrom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">fromhints</span><span class="o">=</span><span class="n">from_hints</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">extra_froms</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PGDDLCompiler</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">DDLCompiler</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get_column_specification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">colspec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preparer</span><span class="o">.</span><span class="n">format_column</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="n">impl_type</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">dialect_impl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">impl_type</span><span class="p">,</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">TypeDecorator</span><span class="p">):</span>
            <span class="n">impl_type</span> <span class="o">=</span> <span class="n">impl_type</span><span class="o">.</span><span class="n">impl</span>

        <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> \
            <span class="n">column</span> <span class="ow">is</span> <span class="n">column</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">_autoincrement_column</span> <span class="ow">and</span> \
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">supports_smallserial</span> <span class="ow">or</span>
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">impl_type</span><span class="p">,</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">SmallInteger</span><span class="p">)</span>
            <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">column</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">schema</span><span class="o">.</span><span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">column</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">optional</span>
                <span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">impl_type</span><span class="p">,</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">BigInteger</span><span class="p">):</span>
                <span class="n">colspec</span> <span class="o">+=</span> <span class="s2">&quot; BIGSERIAL&quot;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">impl_type</span><span class="p">,</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">SmallInteger</span><span class="p">):</span>
                <span class="n">colspec</span> <span class="o">+=</span> <span class="s2">&quot; SMALLSERIAL&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colspec</span> <span class="o">+=</span> <span class="s2">&quot; SERIAL&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colspec</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">type_compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
                <span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">type_expression</span><span class="o">=</span><span class="n">column</span><span class="p">)</span>
            <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_default_string</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">colspec</span> <span class="o">+=</span> <span class="s2">&quot; DEFAULT &quot;</span> <span class="o">+</span> <span class="n">default</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
            <span class="n">colspec</span> <span class="o">+=</span> <span class="s2">&quot; NOT NULL&quot;</span>
        <span class="k">return</span> <span class="n">colspec</span>

    <span class="k">def</span> <span class="nf">visit_create_enum_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">create</span><span class="p">):</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="n">create</span><span class="o">.</span><span class="n">element</span>

        <span class="k">return</span> <span class="s2">&quot;CREATE TYPE </span><span class="si">%s</span><span class="s2"> AS ENUM (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preparer</span><span class="o">.</span><span class="n">format_type</span><span class="p">(</span><span class="n">type_</span><span class="p">),</span>
            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sql_compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">literal_binds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">type_</span><span class="o">.</span><span class="n">enums</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_drop_enum_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drop</span><span class="p">):</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="n">drop</span><span class="o">.</span><span class="n">element</span>

        <span class="k">return</span> <span class="s2">&quot;DROP TYPE </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preparer</span><span class="o">.</span><span class="n">format_type</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_create_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">create</span><span class="p">):</span>
        <span class="n">preparer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preparer</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">create</span><span class="o">.</span><span class="n">element</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_index_table</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;CREATE &quot;</span>
        <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;UNIQUE &quot;</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;INDEX &quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">_supports_create_index_concurrently</span><span class="p">:</span>
            <span class="n">concurrently</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">dialect_options</span><span class="p">[</span><span class="s1">&#39;postgresql&#39;</span><span class="p">][</span><span class="s1">&#39;concurrently&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">concurrently</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;CONCURRENTLY &quot;</span>

        <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> ON </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prepared_index_name</span><span class="p">(</span><span class="n">index</span><span class="p">,</span>
                                      <span class="n">include_schema</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">preparer</span><span class="o">.</span><span class="n">format_table</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">using</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">dialect_options</span><span class="p">[</span><span class="s1">&#39;postgresql&#39;</span><span class="p">][</span><span class="s1">&#39;using&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">using</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;USING </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">preparer</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">using</span><span class="p">)</span>

        <span class="n">ops</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">dialect_options</span><span class="p">[</span><span class="s2">&quot;postgresql&quot;</span><span class="p">][</span><span class="s2">&quot;ops&quot;</span><span class="p">]</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> \
                <span class="o">%</span> <span class="p">(</span>
                    <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sql_compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
                            <span class="n">expr</span><span class="o">.</span><span class="n">self_group</span><span class="p">()</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnClause</span><span class="p">)</span>
                            <span class="k">else</span> <span class="n">expr</span><span class="p">,</span>
                            <span class="n">include_table</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">literal_binds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span>
                        <span class="p">(</span>
                            <span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">ops</span><span class="p">[</span><span class="n">expr</span><span class="o">.</span><span class="n">key</span><span class="p">])</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="n">expr</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">ops</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">index</span><span class="o">.</span><span class="n">expressions</span>
                    <span class="p">])</span>
                <span class="p">)</span>

        <span class="n">withclause</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">dialect_options</span><span class="p">[</span><span class="s1">&#39;postgresql&#39;</span><span class="p">][</span><span class="s1">&#39;with&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">withclause</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot; WITH (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">storage_parameter</span>
                 <span class="k">for</span> <span class="n">storage_parameter</span> <span class="ow">in</span> <span class="n">withclause</span><span class="o">.</span><span class="n">items</span><span class="p">()]))</span>

        <span class="n">tablespace_name</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">dialect_options</span><span class="p">[</span><span class="s1">&#39;postgresql&#39;</span><span class="p">][</span><span class="s1">&#39;tablespace&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">tablespace_name</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot; TABLESPACE </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">preparer</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">tablespace_name</span><span class="p">)</span>

        <span class="n">whereclause</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">dialect_options</span><span class="p">[</span><span class="s2">&quot;postgresql&quot;</span><span class="p">][</span><span class="s2">&quot;where&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">whereclause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">where_compiled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
                <span class="n">whereclause</span><span class="p">,</span> <span class="n">include_table</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">literal_binds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot; WHERE &quot;</span> <span class="o">+</span> <span class="n">where_compiled</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">visit_drop_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drop</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">drop</span><span class="o">.</span><span class="n">element</span>

        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">DROP INDEX &quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">_supports_drop_index_concurrently</span><span class="p">:</span>
            <span class="n">concurrently</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">dialect_options</span><span class="p">[</span><span class="s1">&#39;postgresql&#39;</span><span class="p">][</span><span class="s1">&#39;concurrently&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">concurrently</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;CONCURRENTLY &quot;</span>

        <span class="n">text</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepared_index_name</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">include_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">visit_exclude_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">constraint</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;CONSTRAINT </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">preparer</span><span class="o">.</span><span class="n">format_constraint</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">expr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">constraint</span><span class="o">.</span><span class="n">_render_exprs</span><span class="p">:</span>
            <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;include_table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> WITH </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">),</span> <span class="n">op</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;EXCLUDE USING </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">constraint</span><span class="o">.</span><span class="n">using</span><span class="p">,</span>
                                           <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elements</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">constraint</span><span class="o">.</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39; WHERE (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
                <span class="n">constraint</span><span class="o">.</span><span class="n">where</span><span class="p">,</span>
                <span class="n">literal_binds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_constraint_deferrability</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">post_create_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="n">table_opts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pg_opts</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">dialect_options</span><span class="p">[</span><span class="s1">&#39;postgresql&#39;</span><span class="p">]</span>

        <span class="n">inherits</span> <span class="o">=</span> <span class="n">pg_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inherits&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inherits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherits</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">inherits</span> <span class="o">=</span> <span class="p">(</span><span class="n">inherits</span><span class="p">,</span> <span class="p">)</span>
            <span class="n">table_opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> INHERITS ( &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preparer</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">inherits</span><span class="p">)</span> <span class="o">+</span>
                <span class="s1">&#39; )&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pg_opts</span><span class="p">[</span><span class="s1">&#39;with_oids&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">table_opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> WITH OIDS&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pg_opts</span><span class="p">[</span><span class="s1">&#39;with_oids&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">table_opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> WITHOUT OIDS&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pg_opts</span><span class="p">[</span><span class="s1">&#39;on_commit&#39;</span><span class="p">]:</span>
            <span class="n">on_commit_options</span> <span class="o">=</span> <span class="n">pg_opts</span><span class="p">[</span><span class="s1">&#39;on_commit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">table_opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> ON COMMIT </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">on_commit_options</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pg_opts</span><span class="p">[</span><span class="s1">&#39;tablespace&#39;</span><span class="p">]:</span>
            <span class="n">tablespace_name</span> <span class="o">=</span> <span class="n">pg_opts</span><span class="p">[</span><span class="s1">&#39;tablespace&#39;</span><span class="p">]</span>
            <span class="n">table_opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> TABLESPACE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">preparer</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">tablespace_name</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">table_opts</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PGTypeCompiler</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">GenericTypeCompiler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">visit_TSVECTOR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;TSVECTOR&quot;</span>

    <span class="k">def</span> <span class="nf">visit_INET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;INET&quot;</span>

    <span class="k">def</span> <span class="nf">visit_CIDR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;CIDR&quot;</span>

    <span class="k">def</span> <span class="nf">visit_MACADDR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;MACADDR&quot;</span>

    <span class="k">def</span> <span class="nf">visit_MONEY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;MONEY&quot;</span>

    <span class="k">def</span> <span class="nf">visit_OID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;OID&quot;</span>

    <span class="k">def</span> <span class="nf">visit_FLOAT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">type_</span><span class="o">.</span><span class="n">precision</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;FLOAT&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;FLOAT(</span><span class="si">%(precision)s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">type_</span><span class="o">.</span><span class="n">precision</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">visit_DOUBLE_PRECISION</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;DOUBLE PRECISION&quot;</span>

    <span class="k">def</span> <span class="nf">visit_BIGINT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;BIGINT&quot;</span>

    <span class="k">def</span> <span class="nf">visit_HSTORE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;HSTORE&quot;</span>

    <span class="k">def</span> <span class="nf">visit_JSON</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;JSON&quot;</span>

    <span class="k">def</span> <span class="nf">visit_JSONB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;JSONB&quot;</span>

    <span class="k">def</span> <span class="nf">visit_INT4RANGE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;INT4RANGE&quot;</span>

    <span class="k">def</span> <span class="nf">visit_INT8RANGE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;INT8RANGE&quot;</span>

    <span class="k">def</span> <span class="nf">visit_NUMRANGE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;NUMRANGE&quot;</span>

    <span class="k">def</span> <span class="nf">visit_DATERANGE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;DATERANGE&quot;</span>

    <span class="k">def</span> <span class="nf">visit_TSRANGE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;TSRANGE&quot;</span>

    <span class="k">def</span> <span class="nf">visit_TSTZRANGE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;TSTZRANGE&quot;</span>

    <span class="k">def</span> <span class="nf">visit_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_TIMESTAMP</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_enum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">type_</span><span class="o">.</span><span class="n">native_enum</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">supports_native_enum</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">PGTypeCompiler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">visit_enum</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_ENUM</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_ENUM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">identifier_preparer</span><span class="o">.</span><span class="n">format_type</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_TIMESTAMP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;TIMESTAMP</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s2">&quot;(</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">type_</span><span class="o">.</span><span class="n">precision</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">type_</span><span class="o">.</span><span class="n">timezone</span> <span class="ow">and</span> <span class="s2">&quot;WITH&quot;</span> <span class="ow">or</span> <span class="s2">&quot;WITHOUT&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; TIME ZONE&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_TIME</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;TIME</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s2">&quot;(</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">type_</span><span class="o">.</span><span class="n">precision</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">type_</span><span class="o">.</span><span class="n">timezone</span> <span class="ow">and</span> <span class="s2">&quot;WITH&quot;</span> <span class="ow">or</span> <span class="s2">&quot;WITHOUT&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; TIME ZONE&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_INTERVAL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;INTERVAL&quot;</span>
        <span class="k">if</span> <span class="n">type_</span><span class="o">.</span><span class="n">fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">type_</span><span class="o">.</span><span class="n">fields</span>
        <span class="k">if</span> <span class="n">type_</span><span class="o">.</span><span class="n">precision</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot; (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">type_</span><span class="o">.</span><span class="n">precision</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">visit_BIT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">type_</span><span class="o">.</span><span class="n">varying</span><span class="p">:</span>
            <span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;BIT VARYING&quot;</span>
            <span class="k">if</span> <span class="n">type_</span><span class="o">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">compiled</span> <span class="o">+=</span> <span class="s2">&quot;(</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">type_</span><span class="o">.</span><span class="n">length</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compiled</span> <span class="o">=</span> <span class="s2">&quot;BIT(</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">type_</span><span class="o">.</span><span class="n">length</span>
        <span class="k">return</span> <span class="n">compiled</span>

    <span class="k">def</span> <span class="nf">visit_UUID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;UUID&quot;</span>

    <span class="k">def</span> <span class="nf">visit_large_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_BYTEA</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_BYTEA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;BYTEA&quot;</span>

    <span class="k">def</span> <span class="nf">visit_ARRAY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>

        <span class="c1"># TODO: pass **kw?</span>
        <span class="n">inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">type_</span><span class="o">.</span><span class="n">item_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;((?: COLLATE.*)?)$&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">\1&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="s2">&quot;[]&quot;</span> <span class="o">*</span>
                <span class="p">(</span><span class="n">type_</span><span class="o">.</span><span class="n">dimensions</span> <span class="k">if</span> <span class="n">type_</span><span class="o">.</span><span class="n">dimensions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)),</span>
            <span class="n">inner</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">PGIdentifierPreparer</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">IdentifierPreparer</span><span class="p">):</span>

    <span class="n">reserved_words</span> <span class="o">=</span> <span class="n">RESERVED_WORDS</span>

    <span class="k">def</span> <span class="nf">_unquote_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_quote</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span>\
                <span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">escape_to_quote</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">escape_quote</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">format_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">use_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">type_</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">CompileError</span><span class="p">(</span><span class="s2">&quot;PostgreSQL ENUM type requires a name.&quot;</span><span class="p">)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">type_</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">effective_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_for_object</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">omit_schema</span> <span class="ow">and</span> <span class="n">use_schema</span> <span class="ow">and</span> \
                <span class="n">effective_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote_schema</span><span class="p">(</span><span class="n">effective_schema</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">return</span> <span class="n">name</span>


<span class="k">class</span> <span class="nc">PGInspector</span><span class="p">(</span><span class="n">reflection</span><span class="o">.</span><span class="n">Inspector</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="n">reflection</span><span class="o">.</span><span class="n">Inspector</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_table_oid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the OID for the given table name.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">get_table_oid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span>
                                          <span class="n">info_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info_cache</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_enums</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of ENUM objects.</span>

<span class="sd">        Each member is a dictionary containing these fields:</span>

<span class="sd">            * name - name of the enum</span>
<span class="sd">            * schema - the schema name for the enum.</span>
<span class="sd">            * visible - boolean, whether or not this enum is visible</span>
<span class="sd">              in the default search path.</span>
<span class="sd">            * labels - a list of string labels that apply to the enum.</span>

<span class="sd">        :param schema: schema name.  If None, the default schema</span>
<span class="sd">         (typically &#39;public&#39;) is used.  May also be set to &#39;*&#39; to</span>
<span class="sd">         indicate load enums for all schemas.</span>

<span class="sd">        .. versionadded:: 1.0.0</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_schema_name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">_load_enums</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_foreign_table_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of FOREIGN TABLE names.</span>

<span class="sd">        Behavior is similar to that of :meth:`.Inspector.get_table_names`,</span>
<span class="sd">        except that the list is limited to those tables tha report a</span>
<span class="sd">        ``relkind`` value of ``f``.</span>

<span class="sd">        .. versionadded:: 1.0.0</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_schema_name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">_get_foreign_table_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_view_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;plain&#39;</span><span class="p">,</span> <span class="s1">&#39;materialized&#39;</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;Return all view names in `schema`.</span>

<span class="sd">        :param schema: Optional, retrieve names from a non-default schema.</span>
<span class="sd">         For special quoting, use :class:`.quoted_name`.</span>

<span class="sd">        :param include: specify which types of views to return.  Passed</span>
<span class="sd">         as a string value (for a single type) or a tuple (for any number</span>
<span class="sd">         of types).  Defaults to ``(&#39;plain&#39;, &#39;materialized&#39;)``.</span>

<span class="sd">         .. versionadded:: 1.1</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">get_view_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span>
                                           <span class="n">info_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info_cache</span><span class="p">,</span>
                                           <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CreateEnumType</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">_CreateDropBase</span><span class="p">):</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">&quot;create_enum_type&quot;</span>


<span class="k">class</span> <span class="nc">DropEnumType</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">_CreateDropBase</span><span class="p">):</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s2">&quot;drop_enum_type&quot;</span>


<span class="k">class</span> <span class="nc">PGExecutionContext</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">DefaultExecutionContext</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">fire_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_scalar</span><span class="p">((</span>
            <span class="s2">&quot;select nextval(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">identifier_preparer</span><span class="o">.</span><span class="n">format_sequence</span><span class="p">(</span><span class="n">seq</span><span class="p">)),</span> <span class="n">type_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_insert_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> \
                <span class="n">column</span> <span class="ow">is</span> <span class="n">column</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">_autoincrement_column</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">server_default</span> <span class="ow">and</span> <span class="n">column</span><span class="o">.</span><span class="n">server_default</span><span class="o">.</span><span class="n">has_argument</span><span class="p">:</span>

                <span class="c1"># pre-execute passive defaults on primary key columns</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_scalar</span><span class="p">(</span><span class="s2">&quot;select </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                            <span class="n">column</span><span class="o">.</span><span class="n">server_default</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span>
                                            <span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

            <span class="k">elif</span> <span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                  <span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">is_sequence</span> <span class="ow">and</span>
                   <span class="n">column</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">optional</span><span class="p">)):</span>

                <span class="c1"># execute the sequence associated with a SERIAL primary</span>
                <span class="c1"># key column. for non-primary-key SERIAL, the ID just</span>
                <span class="c1"># generates server side.</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">seq_name</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">_postgresql_seq_name</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">tab</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">tab</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">29</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">29</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)))]</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">29</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">29</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tab</span><span class="p">)))]</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_seq&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
                    <span class="n">column</span><span class="o">.</span><span class="n">_postgresql_seq_name</span> <span class="o">=</span> <span class="n">seq_name</span> <span class="o">=</span> <span class="n">name</span>

                <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">effective_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">schema_for_object</span><span class="p">(</span>
                        <span class="n">column</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">effective_schema</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">effective_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">exc</span> <span class="o">=</span> <span class="s2">&quot;select nextval(&#39;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">.</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">effective_schema</span><span class="p">,</span> <span class="n">seq_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">exc</span> <span class="o">=</span> <span class="s2">&quot;select nextval(&#39;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">seq_name</span><span class="p">,</span> <span class="p">)</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_scalar</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">PGExecutionContext</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_insert_default</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">should_autocommit_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statement</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AUTOCOMMIT_REGEXP</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PGDialect</span><span class="p">(</span><span class="n">default</span><span class="o">.</span><span class="n">DefaultDialect</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;postgresql&#39;</span>
    <span class="n">supports_alter</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">max_identifier_length</span> <span class="o">=</span> <span class="mi">63</span>
    <span class="n">supports_sane_rowcount</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">supports_native_enum</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">supports_native_boolean</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">supports_smallserial</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">supports_sequences</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">sequences_optional</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">preexecute_autoincrement_sequences</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">postfetch_lastrowid</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">supports_comments</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">supports_default_values</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">supports_empty_insert</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">supports_multivalues_insert</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">default_paramstyle</span> <span class="o">=</span> <span class="s1">&#39;pyformat&#39;</span>
    <span class="n">ischema_names</span> <span class="o">=</span> <span class="n">ischema_names</span>
    <span class="n">colspecs</span> <span class="o">=</span> <span class="n">colspecs</span>

    <span class="n">statement_compiler</span> <span class="o">=</span> <span class="n">PGCompiler</span>
    <span class="n">ddl_compiler</span> <span class="o">=</span> <span class="n">PGDDLCompiler</span>
    <span class="n">type_compiler</span> <span class="o">=</span> <span class="n">PGTypeCompiler</span>
    <span class="n">preparer</span> <span class="o">=</span> <span class="n">PGIdentifierPreparer</span>
    <span class="n">execution_ctx_cls</span> <span class="o">=</span> <span class="n">PGExecutionContext</span>
    <span class="n">inspector</span> <span class="o">=</span> <span class="n">PGInspector</span>
    <span class="n">isolation_level</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">construct_arguments</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="p">{</span>
            <span class="s2">&quot;using&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;where&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;ops&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;concurrently&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;with&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;tablespace&quot;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}),</span>
        <span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span> <span class="p">{</span>
            <span class="s2">&quot;ignore_search_path&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;tablespace&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;with_oids&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;on_commit&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;inherits&quot;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}),</span>
    <span class="p">]</span>

    <span class="n">reflection_options</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;postgresql_ignore_search_path&#39;</span><span class="p">,</span> <span class="p">)</span>

    <span class="n">_backslash_escapes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_supports_create_index_concurrently</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_supports_drop_index_concurrently</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isolation_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">json_serializer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">json_deserializer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">default</span><span class="o">.</span><span class="n">DefaultDialect</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="n">isolation_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_json_deserializer</span> <span class="o">=</span> <span class="n">json_deserializer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_json_serializer</span> <span class="o">=</span> <span class="n">json_serializer</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PGDialect</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">implicit_returning</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version_info</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;implicit_returning&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">supports_native_enum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">supports_native_enum</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colspecs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colspecs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># pop base Enum type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colspecs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Enum</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># psycopg2, others may have placed ENUM here as well</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colspecs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ENUM</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># http://www.postgresql.org/docs/9.3/static/release-9-2.html#AEN116689</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">supports_smallserial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_backslash_escapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="n">connection</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
            <span class="s2">&quot;show standard_conforming_strings&quot;</span>
        <span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;off&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_supports_create_index_concurrently</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">server_version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_supports_drop_index_concurrently</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">server_version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolation_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">isolation_level</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">connect</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="n">_isolation_lookup</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;SERIALIZABLE&#39;</span><span class="p">,</span> <span class="s1">&#39;READ UNCOMMITTED&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;READ COMMITTED&#39;</span><span class="p">,</span> <span class="s1">&#39;REPEATABLE READ&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">set_isolation_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isolation_lookup</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid value &#39;</span><span class="si">%s</span><span class="s2">&#39; for isolation_level. &quot;</span>
                <span class="s2">&quot;Valid isolation levels for </span><span class="si">%s</span><span class="s2"> are </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_isolation_lookup</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;SET SESSION CHARACTERISTICS AS TRANSACTION &quot;</span>
            <span class="s2">&quot;ISOLATION LEVEL </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">level</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_isolation_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;show transaction isolation level&#39;</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">do_begin_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">xid</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_begin</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_prepare_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">xid</span><span class="p">):</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PREPARE TRANSACTION &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">xid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_rollback_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span>
                             <span class="n">is_prepared</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">recover</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_prepared</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">recover</span><span class="p">:</span>
                <span class="c1"># FIXME: ugly hack to get out of transaction</span>
                <span class="c1"># context when committing recoverable transactions</span>
                <span class="c1"># Must find out a way how to make the dbapi not</span>
                <span class="c1"># open a transaction.</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ROLLBACK&quot;</span><span class="p">)</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ROLLBACK PREPARED &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">xid</span><span class="p">)</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_rollback</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_rollback</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_commit_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span>
                           <span class="n">is_prepared</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">recover</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_prepared</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">recover</span><span class="p">:</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;ROLLBACK&quot;</span><span class="p">)</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;COMMIT PREPARED &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">xid</span><span class="p">)</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_rollback</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_commit</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_recover_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="n">resultset</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT gid FROM pg_prepared_xacts&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_default_schema_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="s2">&quot;select current_schema()&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;select nspname from pg_namespace &quot;</span>
                 <span class="s2">&quot;where lower(nspname)=:schema&quot;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">query</span><span class="p">,</span>
                <span class="n">bindparams</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">sql</span><span class="o">.</span><span class="n">bindparam</span><span class="p">(</span>
                        <span class="s1">&#39;schema&#39;</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span>
                        <span class="n">type_</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">has_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># seems like case gets folded in pg_class...</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="s2">&quot;select relname from pg_class c join pg_namespace n on &quot;</span>
                    <span class="s2">&quot;n.oid=c.relnamespace where &quot;</span>
                    <span class="s2">&quot;pg_catalog.pg_table_is_visible(c.oid) &quot;</span>
                    <span class="s2">&quot;and relname=:name&quot;</span><span class="p">,</span>
                    <span class="n">bindparams</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">sql</span><span class="o">.</span><span class="n">bindparam</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                                      <span class="n">type_</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="s2">&quot;select relname from pg_class c join pg_namespace n on &quot;</span>
                    <span class="s2">&quot;n.oid=c.relnamespace where n.nspname=:schema and &quot;</span>
                    <span class="s2">&quot;relname=:name&quot;</span><span class="p">,</span>
                    <span class="n">bindparams</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">sql</span><span class="o">.</span><span class="n">bindparam</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>
                                      <span class="n">util</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                                      <span class="n">type_</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">),</span>
                        <span class="n">sql</span><span class="o">.</span><span class="n">bindparam</span><span class="p">(</span><span class="s1">&#39;schema&#39;</span><span class="p">,</span>
                                      <span class="n">util</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">schema</span><span class="p">),</span>
                                      <span class="n">type_</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">has_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">sequence_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="s2">&quot;SELECT relname FROM pg_class c join pg_namespace n on &quot;</span>
                    <span class="s2">&quot;n.oid=c.relnamespace where relkind=&#39;S&#39; and &quot;</span>
                    <span class="s2">&quot;n.nspname=current_schema() &quot;</span>
                    <span class="s2">&quot;and relname=:name&quot;</span><span class="p">,</span>
                    <span class="n">bindparams</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">sql</span><span class="o">.</span><span class="n">bindparam</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">sequence_name</span><span class="p">),</span>
                                      <span class="n">type_</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="s2">&quot;SELECT relname FROM pg_class c join pg_namespace n on &quot;</span>
                    <span class="s2">&quot;n.oid=c.relnamespace where relkind=&#39;S&#39; and &quot;</span>
                    <span class="s2">&quot;n.nspname=:schema and relname=:name&quot;</span><span class="p">,</span>
                    <span class="n">bindparams</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">sql</span><span class="o">.</span><span class="n">bindparam</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">sequence_name</span><span class="p">),</span>
                                      <span class="n">type_</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">),</span>
                        <span class="n">sql</span><span class="o">.</span><span class="n">bindparam</span><span class="p">(</span><span class="s1">&#39;schema&#39;</span><span class="p">,</span>
                                      <span class="n">util</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">schema</span><span class="p">),</span>
                                      <span class="n">type_</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">has_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT EXISTS (</span>
<span class="s2">                SELECT * FROM pg_catalog.pg_type t, pg_catalog.pg_namespace n</span>
<span class="s2">                WHERE t.typnamespace = n.oid</span>
<span class="s2">                AND t.typname = :typname</span>
<span class="s2">                AND n.nspname = :nspname</span>
<span class="s2">                )</span>
<span class="s2">                &quot;&quot;&quot;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT EXISTS (</span>
<span class="s2">                SELECT * FROM pg_catalog.pg_type t</span>
<span class="s2">                WHERE t.typname = :typname</span>
<span class="s2">                AND pg_type_is_visible(t.oid)</span>
<span class="s2">                )</span>
<span class="s2">                &quot;&quot;&quot;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">bindparams</span><span class="p">(</span>
            <span class="n">sql</span><span class="o">.</span><span class="n">bindparam</span><span class="p">(</span><span class="s1">&#39;typname&#39;</span><span class="p">,</span>
                          <span class="n">util</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">type_name</span><span class="p">),</span> <span class="n">type_</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">bindparams</span><span class="p">(</span>
                <span class="n">sql</span><span class="o">.</span><span class="n">bindparam</span><span class="p">(</span><span class="s1">&#39;nspname&#39;</span><span class="p">,</span>
                              <span class="n">util</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">schema</span><span class="p">),</span> <span class="n">type_</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">scalar</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_get_server_version_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select version()&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;.*(?:PostgreSQL|EnterpriseDB) &#39;</span>
            <span class="sa">r</span><span class="s1">&#39;(\d+)\.?(\d+)?(?:\.(\d+))?(?:\.\d+)?(?:devel|beta)?&#39;</span><span class="p">,</span>
            <span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="s2">&quot;Could not determine version from string &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>

    <span class="nd">@reflection</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">get_table_oid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch the oid for schema.table_name.</span>

<span class="sd">        Several reflection methods require the table oid.  The idea for using</span>
<span class="sd">        this method is that it can be fetched one time and cached for</span>
<span class="sd">        subsequent calls.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table_oid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">schema_where_clause</span> <span class="o">=</span> <span class="s2">&quot;n.nspname = :schema&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">schema_where_clause</span> <span class="o">=</span> <span class="s2">&quot;pg_catalog.pg_table_is_visible(c.oid)&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT c.oid</span>
<span class="s2">            FROM pg_catalog.pg_class c</span>
<span class="s2">            LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace</span>
<span class="s2">            WHERE (</span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">            AND c.relname = :table_name AND c.relkind in (&#39;r&#39;, &#39;v&#39;, &#39;m&#39;, &#39;f&#39;)</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">schema_where_clause</span>
        <span class="c1"># Since we&#39;re binding to unicode, table_name and schema_name must be</span>
        <span class="c1"># unicode.</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">bindparams</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="n">oid</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">schema</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">bindparams</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">bindparam</span><span class="p">(</span><span class="s1">&#39;schema&#39;</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">))</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">table_oid</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">table_oid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">NoSuchTableError</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">table_oid</span>

    <span class="nd">@reflection</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">get_schema_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT nspname FROM pg_namespace &quot;</span>
                     <span class="s2">&quot;WHERE nspname NOT LIKE &#39;pg_%&#39; &quot;</span>
                     <span class="s2">&quot;ORDER BY nspname&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="n">nspname</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>

    <span class="nd">@reflection</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">get_table_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT c.relname FROM pg_class c &quot;</span>
                     <span class="s2">&quot;JOIN pg_namespace n ON n.oid = c.relnamespace &quot;</span>
                     <span class="s2">&quot;WHERE n.nspname = :schema AND c.relkind = &#39;r&#39;&quot;</span>
                     <span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="n">relname</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">),</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span> <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_schema_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>

    <span class="nd">@reflection</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">_get_foreign_table_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT c.relname FROM pg_class c &quot;</span>
                     <span class="s2">&quot;JOIN pg_namespace n ON n.oid = c.relnamespace &quot;</span>
                     <span class="s2">&quot;WHERE n.nspname = :schema AND c.relkind = &#39;f&#39;&quot;</span>
                     <span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="n">relname</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">),</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span> <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_schema_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>

    <span class="nd">@reflection</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">get_view_names</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">include</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;plain&#39;</span><span class="p">,</span> <span class="s1">&#39;materialized&#39;</span><span class="p">),</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>

        <span class="n">include_kind</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;plain&#39;</span><span class="p">:</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;materialized&#39;</span><span class="p">:</span> <span class="s1">&#39;m&#39;</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kinds</span> <span class="o">=</span> <span class="p">[</span><span class="n">include_kind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">include</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;include </span><span class="si">%r</span><span class="s2"> unknown, needs to be a sequence containing &quot;</span>
                <span class="s2">&quot;one or both of &#39;plain&#39; and &#39;materialized&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">include</span><span class="p">,))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kinds</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;empty include, needs to be a sequence containing &quot;</span>
                <span class="s2">&quot;one or both of &#39;plain&#39; and &#39;materialized&#39;&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT c.relname FROM pg_class c &quot;</span>
                     <span class="s2">&quot;JOIN pg_namespace n ON n.oid = c.relnamespace &quot;</span>
                     <span class="s2">&quot;WHERE n.nspname = :schema AND c.relkind IN (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span>
                     <span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">kinds</span><span class="p">))</span>
                     <span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="n">relname</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">),</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span> <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_schema_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>

    <span class="nd">@reflection</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">get_view_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">view_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">view_def</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
            <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT pg_get_viewdef(c.oid) view_def FROM pg_class c &quot;</span>
                     <span class="s2">&quot;JOIN pg_namespace n ON n.oid = c.relnamespace &quot;</span>
                     <span class="s2">&quot;WHERE n.nspname = :schema AND c.relname = :view_name &quot;</span>
                     <span class="s2">&quot;AND c.relkind IN (&#39;v&#39;, &#39;m&#39;)&quot;</span>
                     <span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="n">view_def</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">),</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span> <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_schema_name</span><span class="p">,</span>
            <span class="n">view_name</span><span class="o">=</span><span class="n">view_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">view_def</span>

    <span class="nd">@reflection</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>

        <span class="n">table_oid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_oid</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span>
                                       <span class="n">info_cache</span><span class="o">=</span><span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;info_cache&#39;</span><span class="p">))</span>
        <span class="n">SQL_COLS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT a.attname,</span>
<span class="s2">              pg_catalog.format_type(a.atttypid, a.atttypmod),</span>
<span class="s2">              (SELECT pg_catalog.pg_get_expr(d.adbin, d.adrelid)</span>
<span class="s2">                FROM pg_catalog.pg_attrdef d</span>
<span class="s2">               WHERE d.adrelid = a.attrelid AND d.adnum = a.attnum</span>
<span class="s2">               AND a.atthasdef)</span>
<span class="s2">              AS DEFAULT,</span>
<span class="s2">              a.attnotnull, a.attnum, a.attrelid as table_oid,</span>
<span class="s2">              pgd.description as comment</span>
<span class="s2">            FROM pg_catalog.pg_attribute a</span>
<span class="s2">            LEFT JOIN pg_catalog.pg_description pgd ON (</span>
<span class="s2">                pgd.objoid = a.attrelid AND pgd.objsubid = a.attnum)</span>
<span class="s2">            WHERE a.attrelid = :table_oid</span>
<span class="s2">            AND a.attnum &gt; 0 AND NOT a.attisdropped</span>
<span class="s2">            ORDER BY a.attnum</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">SQL_COLS</span><span class="p">,</span>
                     <span class="n">bindparams</span><span class="o">=</span><span class="p">[</span>
                         <span class="n">sql</span><span class="o">.</span><span class="n">bindparam</span><span class="p">(</span><span class="s1">&#39;table_oid&#39;</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">Integer</span><span class="p">)],</span>
                     <span class="n">typemap</span><span class="o">=</span><span class="p">{</span>
                         <span class="s1">&#39;attname&#39;</span><span class="p">:</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
                         <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">}</span>
                     <span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">table_oid</span><span class="o">=</span><span class="n">table_oid</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">domains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_domains</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="n">enums</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;schema&#39;</span><span class="p">],</span> <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;visible&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">rec</span><span class="p">)</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_enums</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># format columns</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">format_type</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">notnull</span><span class="p">,</span> <span class="n">attnum</span><span class="p">,</span> <span class="n">table_oid</span><span class="p">,</span> \
                <span class="n">comment</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">column_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_column_info</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">format_type</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">notnull</span><span class="p">,</span> <span class="n">domains</span><span class="p">,</span> <span class="n">enums</span><span class="p">,</span>
                <span class="n">schema</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_info</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">columns</span>

    <span class="k">def</span> <span class="nf">_get_column_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">format_type</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span>
                         <span class="n">notnull</span><span class="p">,</span> <span class="n">domains</span><span class="p">,</span> <span class="n">enums</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
        <span class="c1"># strip (*) from character varying(5), timestamp(5)</span>
        <span class="c1"># with time zone, geometry(POLYGON), etc.</span>
        <span class="n">attype</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\(.*\)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">format_type</span><span class="p">)</span>

        <span class="c1"># strip &#39;[]&#39; from integer[], etc.</span>
        <span class="n">attype</span> <span class="o">=</span> <span class="n">attype</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">nullable</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">notnull</span>
        <span class="n">is_array</span> <span class="o">=</span> <span class="n">format_type</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;[]&#39;</span><span class="p">)</span>
        <span class="n">charlen</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\(([\d,]+)\)&#39;</span><span class="p">,</span> <span class="n">format_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">charlen</span><span class="p">:</span>
            <span class="n">charlen</span> <span class="o">=</span> <span class="n">charlen</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\((.*)\)&#39;</span><span class="p">,</span> <span class="n">format_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s*,\s*&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">attype</span> <span class="o">==</span> <span class="s1">&#39;numeric&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">charlen</span><span class="p">:</span>
                <span class="n">prec</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">charlen</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">prec</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">scale</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">elif</span> <span class="n">attype</span> <span class="o">==</span> <span class="s1">&#39;double precision&#39;</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="mi">53</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">attype</span> <span class="o">==</span> <span class="s1">&#39;integer&#39;</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">elif</span> <span class="n">attype</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;timestamp with time zone&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;time with time zone&#39;</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">charlen</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">charlen</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">elif</span> <span class="n">attype</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;timestamp without time zone&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;time without time zone&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">charlen</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">charlen</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">elif</span> <span class="n">attype</span> <span class="o">==</span> <span class="s1">&#39;bit varying&#39;</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;varying&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">charlen</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">charlen</span><span class="p">),)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">elif</span> <span class="n">attype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;interval&#39;</span><span class="p">):</span>
            <span class="n">field_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;interval (.+)&#39;</span><span class="p">,</span> <span class="n">attype</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">charlen</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">charlen</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_match</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">attype</span> <span class="o">=</span> <span class="s2">&quot;interval&quot;</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">elif</span> <span class="n">charlen</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">charlen</span><span class="p">),)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ischema_names</span><span class="p">:</span>
                <span class="n">coltype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ischema_names</span><span class="p">[</span><span class="n">attype</span><span class="p">]</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">attype</span> <span class="ow">in</span> <span class="n">enums</span><span class="p">:</span>
                <span class="n">enum</span> <span class="o">=</span> <span class="n">enums</span><span class="p">[</span><span class="n">attype</span><span class="p">]</span>
                <span class="n">coltype</span> <span class="o">=</span> <span class="n">ENUM</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">enum</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">enum</span><span class="p">[</span><span class="s1">&#39;visible&#39;</span><span class="p">]:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;schema&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">enum</span><span class="p">[</span><span class="s1">&#39;schema&#39;</span><span class="p">]</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">enum</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">])</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">attype</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">:</span>
                <span class="n">domain</span> <span class="o">=</span> <span class="n">domains</span><span class="p">[</span><span class="n">attype</span><span class="p">]</span>
                <span class="n">attype</span> <span class="o">=</span> <span class="n">domain</span><span class="p">[</span><span class="s1">&#39;attype&#39;</span><span class="p">]</span>
                <span class="c1"># A table can&#39;t override whether the domain is nullable.</span>
                <span class="n">nullable</span> <span class="o">=</span> <span class="n">domain</span><span class="p">[</span><span class="s1">&#39;nullable&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">domain</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">default</span><span class="p">:</span>
                    <span class="c1"># It can, however, override the default</span>
                    <span class="c1"># value, but can&#39;t set it to null.</span>
                    <span class="n">default</span> <span class="o">=</span> <span class="n">domain</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coltype</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">coltype</span><span class="p">:</span>
            <span class="n">coltype</span> <span class="o">=</span> <span class="n">coltype</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_array</span><span class="p">:</span>
                <span class="n">coltype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ischema_names</span><span class="p">[</span><span class="s1">&#39;_array&#39;</span><span class="p">](</span><span class="n">coltype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Did not recognize type &#39;</span><span class="si">%s</span><span class="s2">&#39; of column &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">attype</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="n">coltype</span> <span class="o">=</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">NULLTYPE</span>
        <span class="c1"># adjust the default value</span>
        <span class="n">autoincrement</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;(nextval\(&#39;)([^&#39;]+)(&#39;.*$)&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">coltype</span><span class="o">.</span><span class="n">_type_affinity</span><span class="p">,</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">Integer</span><span class="p">):</span>
                    <span class="n">autoincrement</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># the default is related to a Sequence</span>
                <span class="n">sch</span> <span class="o">=</span> <span class="n">schema</span>
                <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># unconditionally quote the schema name.  this could</span>
                    <span class="c1"># later be enhanced to obey quoting rules /</span>
                    <span class="c1"># &quot;quote schema&quot;</span>
                    <span class="n">default</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> \
                        <span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">sch</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> \
                        <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">column_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">coltype</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="n">nullable</span><span class="p">,</span>
                           <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="n">autoincrement</span><span class="p">,</span>
                           <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">column_info</span>

    <span class="nd">@reflection</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">get_pk_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">table_oid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_oid</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span>
                                       <span class="n">info_cache</span><span class="o">=</span><span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;info_cache&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">PK_SQL</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT a.attname</span>
<span class="s2">                FROM</span>
<span class="s2">                    pg_class t</span>
<span class="s2">                    join pg_index ix on t.oid = ix.indrelid</span>
<span class="s2">                    join pg_attribute a</span>
<span class="s2">                        on t.oid=a.attrelid AND </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                 WHERE</span>
<span class="s2">                  t.oid = :table_oid and ix.indisprimary = &#39;t&#39;</span>
<span class="s2">                ORDER BY a.attnum</span>
<span class="s2">            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pg_index_any</span><span class="p">(</span><span class="s2">&quot;a.attnum&quot;</span><span class="p">,</span> <span class="s2">&quot;ix.indkey&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># unnest() and generate_subscripts() both introduced in</span>
            <span class="c1"># version 8.4</span>
            <span class="n">PK_SQL</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT a.attname</span>
<span class="s2">                FROM pg_attribute a JOIN (</span>
<span class="s2">                    SELECT unnest(ix.indkey) attnum,</span>
<span class="s2">                           generate_subscripts(ix.indkey, 1) ord</span>
<span class="s2">                    FROM pg_index ix</span>
<span class="s2">                    WHERE ix.indrelid = :table_oid AND ix.indisprimary</span>
<span class="s2">                    ) k ON a.attnum=k.attnum</span>
<span class="s2">                WHERE a.attrelid = :table_oid</span>
<span class="s2">                ORDER BY k.ord</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">PK_SQL</span><span class="p">,</span> <span class="n">typemap</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attname&#39;</span><span class="p">:</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">})</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">table_oid</span><span class="o">=</span><span class="n">table_oid</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

        <span class="n">PK_CONS_SQL</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT conname</span>
<span class="s2">           FROM  pg_catalog.pg_constraint r</span>
<span class="s2">           WHERE r.conrelid = :table_oid AND r.contype = &#39;p&#39;</span>
<span class="s2">           ORDER BY 1</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">PK_CONS_SQL</span><span class="p">,</span> <span class="n">typemap</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;conname&#39;</span><span class="p">:</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">})</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">table_oid</span><span class="o">=</span><span class="n">table_oid</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;constrained_columns&#39;</span><span class="p">:</span> <span class="n">cols</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>

    <span class="nd">@reflection</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">get_foreign_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">postgresql_ignore_search_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">preparer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier_preparer</span>
        <span class="n">table_oid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_oid</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span>
                                       <span class="n">info_cache</span><span class="o">=</span><span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;info_cache&#39;</span><span class="p">))</span>

        <span class="n">FK_SQL</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">          SELECT r.conname,</span>
<span class="s2">                pg_catalog.pg_get_constraintdef(r.oid, true) as condef,</span>
<span class="s2">                n.nspname as conschema</span>
<span class="s2">          FROM  pg_catalog.pg_constraint r,</span>
<span class="s2">                pg_namespace n,</span>
<span class="s2">                pg_class c</span>

<span class="s2">          WHERE r.conrelid = :table AND</span>
<span class="s2">                r.contype = &#39;f&#39; AND</span>
<span class="s2">                c.oid = confrelid AND</span>
<span class="s2">                n.oid = c.relnamespace</span>
<span class="s2">          ORDER BY 1</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="c1"># http://www.postgresql.org/docs/9.0/static/sql-createtable.html</span>
        <span class="n">FK_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;FOREIGN KEY \((.*?)\) REFERENCES (?:(.*?)\.)?(.*?)\((.*?)\)&#39;</span>
            <span class="sa">r</span><span class="s1">&#39;[\s]?(MATCH (FULL|PARTIAL|SIMPLE)+)?&#39;</span>
            <span class="sa">r</span><span class="s1">&#39;[\s]?(ON UPDATE &#39;</span>
            <span class="sa">r</span><span class="s1">&#39;(CASCADE|RESTRICT|NO ACTION|SET NULL|SET DEFAULT)+)?&#39;</span>
            <span class="sa">r</span><span class="s1">&#39;[\s]?(ON DELETE &#39;</span>
            <span class="sa">r</span><span class="s1">&#39;(CASCADE|RESTRICT|NO ACTION|SET NULL|SET DEFAULT)+)?&#39;</span>
            <span class="sa">r</span><span class="s1">&#39;[\s]?(DEFERRABLE|NOT DEFERRABLE)?&#39;</span>
            <span class="sa">r</span><span class="s1">&#39;[\s]?(INITIALLY (DEFERRED|IMMEDIATE)+)?&#39;</span>
        <span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">FK_SQL</span><span class="p">,</span> <span class="n">typemap</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;conname&#39;</span><span class="p">:</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
            <span class="s1">&#39;condef&#39;</span><span class="p">:</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">})</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">table_oid</span><span class="p">)</span>
        <span class="n">fkeys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">conname</span><span class="p">,</span> <span class="n">condef</span><span class="p">,</span> <span class="n">conschema</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">FK_REGEX</span><span class="p">,</span> <span class="n">condef</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>

            <span class="n">constrained_columns</span><span class="p">,</span> <span class="n">referred_schema</span><span class="p">,</span> \
                <span class="n">referred_table</span><span class="p">,</span> <span class="n">referred_columns</span><span class="p">,</span> \
                <span class="n">_</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">onupdate</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ondelete</span><span class="p">,</span> \
                <span class="n">deferrable</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">initially</span> <span class="o">=</span> <span class="n">m</span>

            <span class="k">if</span> <span class="n">deferrable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">deferrable</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">deferrable</span> <span class="o">==</span> <span class="s1">&#39;DEFERRABLE&#39;</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="n">constrained_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">preparer</span><span class="o">.</span><span class="n">_unquote_identifier</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                                   <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                                       <span class="sa">r</span><span class="s1">&#39;\s*,\s*&#39;</span><span class="p">,</span> <span class="n">constrained_columns</span><span class="p">)]</span>

            <span class="k">if</span> <span class="n">postgresql_ignore_search_path</span><span class="p">:</span>
                <span class="c1"># when ignoring search path, we use the actual schema</span>
                <span class="c1"># provided it isn&#39;t the &quot;default&quot; schema</span>
                <span class="k">if</span> <span class="n">conschema</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_schema_name</span><span class="p">:</span>
                    <span class="n">referred_schema</span> <span class="o">=</span> <span class="n">conschema</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">referred_schema</span> <span class="o">=</span> <span class="n">schema</span>
            <span class="k">elif</span> <span class="n">referred_schema</span><span class="p">:</span>
                <span class="c1"># referred_schema is the schema that we regexp&#39;ed from</span>
                <span class="c1"># pg_get_constraintdef().  If the schema is in the search</span>
                <span class="c1"># path, pg_get_constraintdef() will give us None.</span>
                <span class="n">referred_schema</span> <span class="o">=</span> \
                    <span class="n">preparer</span><span class="o">.</span><span class="n">_unquote_identifier</span><span class="p">(</span><span class="n">referred_schema</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">schema</span> <span class="o">==</span> <span class="n">conschema</span><span class="p">:</span>
                <span class="c1"># If the actual schema matches the schema of the table</span>
                <span class="c1"># we&#39;re reflecting, then we will use that.</span>
                <span class="n">referred_schema</span> <span class="o">=</span> <span class="n">schema</span>

            <span class="n">referred_table</span> <span class="o">=</span> <span class="n">preparer</span><span class="o">.</span><span class="n">_unquote_identifier</span><span class="p">(</span><span class="n">referred_table</span><span class="p">)</span>
            <span class="n">referred_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">preparer</span><span class="o">.</span><span class="n">_unquote_identifier</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                                <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s*,\s&#39;</span><span class="p">,</span> <span class="n">referred_columns</span><span class="p">)]</span>
            <span class="n">fkey_d</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">conname</span><span class="p">,</span>
                <span class="s1">&#39;constrained_columns&#39;</span><span class="p">:</span> <span class="n">constrained_columns</span><span class="p">,</span>
                <span class="s1">&#39;referred_schema&#39;</span><span class="p">:</span> <span class="n">referred_schema</span><span class="p">,</span>
                <span class="s1">&#39;referred_table&#39;</span><span class="p">:</span> <span class="n">referred_table</span><span class="p">,</span>
                <span class="s1">&#39;referred_columns&#39;</span><span class="p">:</span> <span class="n">referred_columns</span><span class="p">,</span>
                <span class="s1">&#39;options&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;onupdate&#39;</span><span class="p">:</span> <span class="n">onupdate</span><span class="p">,</span>
                    <span class="s1">&#39;ondelete&#39;</span><span class="p">:</span> <span class="n">ondelete</span><span class="p">,</span>
                    <span class="s1">&#39;deferrable&#39;</span><span class="p">:</span> <span class="n">deferrable</span><span class="p">,</span>
                    <span class="s1">&#39;initially&#39;</span><span class="p">:</span> <span class="n">initially</span><span class="p">,</span>
                    <span class="s1">&#39;match&#39;</span><span class="p">:</span> <span class="n">match</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">fkeys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fkey_d</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fkeys</span>

    <span class="k">def</span> <span class="nf">_pg_index_any</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">compare_to</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># http://www.postgresql.org/message-id/10279.1124395722@sss.pgh.pa.us</span>
            <span class="c1"># &quot;In CVS tip you could replace this with &quot;attnum = ANY (indkey)&quot;.</span>
            <span class="c1"># Unfortunately, most array support doesn&#39;t work on int2vector in</span>
            <span class="c1"># pre-8.1 releases, so I think you&#39;re kinda stuck with the above</span>
            <span class="c1"># for now.</span>
            <span class="c1"># regards, tom lane&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="s2">&quot; OR &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">[</span><span class="si">%d</span><span class="s2">] = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">compare_to</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = ANY(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">compare_to</span><span class="p">)</span>

    <span class="nd">@reflection</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">get_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">table_oid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_oid</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span>
                                       <span class="n">info_cache</span><span class="o">=</span><span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;info_cache&#39;</span><span class="p">))</span>

        <span class="c1"># cast indkey as varchar since it&#39;s an int2vector,</span>
        <span class="c1"># returned as a list by some drivers such as pypostgresql</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
            <span class="n">IDX_SQL</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">              SELECT</span>
<span class="s2">                  i.relname as relname,</span>
<span class="s2">                  ix.indisunique, ix.indexprs, ix.indpred,</span>
<span class="s2">                  a.attname, a.attnum, NULL, ix.indkey</span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                  </span><span class="si">%s</span><span class="s2">, am.amname</span>
<span class="s2">              FROM</span>
<span class="s2">                  pg_class t</span>
<span class="s2">                        join pg_index ix on t.oid = ix.indrelid</span>
<span class="s2">                        join pg_class i on i.oid = ix.indexrelid</span>
<span class="s2">                        left outer join</span>
<span class="s2">                            pg_attribute a</span>
<span class="s2">                            on t.oid = a.attrelid and </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                        left outer join</span>
<span class="s2">                            pg_am am</span>
<span class="s2">                            on i.relam = am.oid</span>
<span class="s2">              WHERE</span>
<span class="s2">                  t.relkind IN (&#39;r&#39;, &#39;v&#39;, &#39;f&#39;, &#39;m&#39;)</span>
<span class="s2">                  and t.oid = :table_oid</span>
<span class="s2">                  and ix.indisprimary = &#39;f&#39;</span>
<span class="s2">              ORDER BY</span>
<span class="s2">                  t.relname,</span>
<span class="s2">                  i.relname</span>
<span class="s2">            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="c1"># version 8.3 here was based on observing the</span>
                <span class="c1"># cast does not work in PG 8.2.4, does work in 8.3.0.</span>
                <span class="c1"># nothing in PG changelogs regarding this.</span>
                <span class="s2">&quot;::varchar&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;i.reloptions&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span> <span class="s2">&quot;NULL&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pg_index_any</span><span class="p">(</span><span class="s2">&quot;a.attnum&quot;</span><span class="p">,</span> <span class="s2">&quot;ix.indkey&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">IDX_SQL</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">              SELECT</span>
<span class="s2">                  i.relname as relname,</span>
<span class="s2">                  ix.indisunique, ix.indexprs, ix.indpred,</span>
<span class="s2">                  a.attname, a.attnum, c.conrelid, ix.indkey::varchar,</span>
<span class="s2">                  i.reloptions, am.amname</span>
<span class="s2">              FROM</span>
<span class="s2">                  pg_class t</span>
<span class="s2">                        join pg_index ix on t.oid = ix.indrelid</span>
<span class="s2">                        join pg_class i on i.oid = ix.indexrelid</span>
<span class="s2">                        left outer join</span>
<span class="s2">                            pg_attribute a</span>
<span class="s2">                            on t.oid = a.attrelid and a.attnum = ANY(ix.indkey)</span>
<span class="s2">                        left outer join</span>
<span class="s2">                            pg_constraint c</span>
<span class="s2">                            on (ix.indrelid = c.conrelid and</span>
<span class="s2">                                ix.indexrelid = c.conindid and</span>
<span class="s2">                                c.contype in (&#39;p&#39;, &#39;u&#39;, &#39;x&#39;))</span>
<span class="s2">                        left outer join</span>
<span class="s2">                            pg_am am</span>
<span class="s2">                            on i.relam = am.oid</span>
<span class="s2">              WHERE</span>
<span class="s2">                  t.relkind IN (&#39;r&#39;, &#39;v&#39;, &#39;f&#39;, &#39;m&#39;)</span>
<span class="s2">                  and t.oid = :table_oid</span>
<span class="s2">                  and ix.indisprimary = &#39;f&#39;</span>
<span class="s2">              ORDER BY</span>
<span class="s2">                  t.relname,</span>
<span class="s2">                  i.relname</span>
<span class="s2">            &quot;&quot;&quot;</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">IDX_SQL</span><span class="p">,</span> <span class="n">typemap</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;relname&#39;</span><span class="p">:</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
            <span class="s1">&#39;attname&#39;</span><span class="p">:</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">})</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">table_oid</span><span class="o">=</span><span class="n">table_oid</span><span class="p">)</span>

        <span class="n">indexes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>

        <span class="n">sv_idx_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="p">(</span><span class="n">idx_name</span><span class="p">,</span> <span class="n">unique</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">prd</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span>
             <span class="n">col_num</span><span class="p">,</span> <span class="n">conrelid</span><span class="p">,</span> <span class="n">idx_key</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">amname</span><span class="p">)</span> <span class="o">=</span> <span class="n">row</span>

            <span class="k">if</span> <span class="n">expr</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">idx_name</span> <span class="o">!=</span> <span class="n">sv_idx_name</span><span class="p">:</span>
                    <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;Skipped unsupported reflection of &quot;</span>
                        <span class="s2">&quot;expression-based index </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="n">idx_name</span><span class="p">)</span>
                <span class="n">sv_idx_name</span> <span class="o">=</span> <span class="n">idx_name</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">prd</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">idx_name</span> <span class="o">==</span> <span class="n">sv_idx_name</span><span class="p">:</span>
                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Predicate of partial index </span><span class="si">%s</span><span class="s2"> ignored during reflection&quot;</span>
                    <span class="o">%</span> <span class="n">idx_name</span><span class="p">)</span>
                <span class="n">sv_idx_name</span> <span class="o">=</span> <span class="n">idx_name</span>

            <span class="n">has_idx</span> <span class="o">=</span> <span class="n">idx_name</span> <span class="ow">in</span> <span class="n">indexes</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">indexes</span><span class="p">[</span><span class="n">idx_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">index</span><span class="p">[</span><span class="s1">&#39;cols&#39;</span><span class="p">][</span><span class="n">col_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_idx</span><span class="p">:</span>
                <span class="n">index</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">idx_key</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                <span class="n">index</span><span class="p">[</span><span class="s1">&#39;unique&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique</span>
                <span class="k">if</span> <span class="n">conrelid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">index</span><span class="p">[</span><span class="s1">&#39;duplicates_constraint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx_name</span>
                <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
                    <span class="n">index</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">option</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">])</span>

                <span class="c1"># it *might* be nice to include that this is &#39;btree&#39; in the</span>
                <span class="c1"># reflection info.  But we don&#39;t want an Index object</span>
                <span class="c1"># to have a ``postgresql_using`` in it that is just the</span>
                <span class="c1"># default, so for the moment leaving this out.</span>
                <span class="k">if</span> <span class="n">amname</span> <span class="ow">and</span> <span class="n">amname</span> <span class="o">!=</span> <span class="s1">&#39;btree&#39;</span><span class="p">:</span>
                    <span class="n">index</span><span class="p">[</span><span class="s1">&#39;amname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">amname</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indexes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;unique&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">[</span><span class="s1">&#39;unique&#39;</span><span class="p">],</span>
                <span class="s1">&#39;column_names&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="s1">&#39;cols&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]]</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="s1">&#39;duplicates_constraint&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;duplicates_constraint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="s1">&#39;duplicates_constraint&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;options&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                    <span class="s1">&#39;dialect_options&#39;</span><span class="p">,</span> <span class="p">{})[</span><span class="s2">&quot;postgresql_with&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;amname&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                    <span class="s1">&#39;dialect_options&#39;</span><span class="p">,</span> <span class="p">{})[</span><span class="s2">&quot;postgresql_using&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="s1">&#39;amname&#39;</span><span class="p">]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@reflection</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">get_unique_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span>
                               <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">table_oid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_oid</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span>
                                       <span class="n">info_cache</span><span class="o">=</span><span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;info_cache&#39;</span><span class="p">))</span>

        <span class="n">UNIQUE_SQL</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT</span>
<span class="s2">                cons.conname as name,</span>
<span class="s2">                cons.conkey as key,</span>
<span class="s2">                a.attnum as col_num,</span>
<span class="s2">                a.attname as col_name</span>
<span class="s2">            FROM</span>
<span class="s2">                pg_catalog.pg_constraint cons</span>
<span class="s2">                join pg_attribute a</span>
<span class="s2">                  on cons.conrelid = a.attrelid AND</span>
<span class="s2">                    a.attnum = ANY(cons.conkey)</span>
<span class="s2">            WHERE</span>
<span class="s2">                cons.conrelid = :table_oid AND</span>
<span class="s2">                cons.contype = &#39;u&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">UNIQUE_SQL</span><span class="p">,</span> <span class="n">typemap</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;col_name&#39;</span><span class="p">:</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">})</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">table_oid</span><span class="o">=</span><span class="n">table_oid</span><span class="p">)</span>

        <span class="n">uniques</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="n">uc</span> <span class="o">=</span> <span class="n">uniques</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="n">uc</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">key</span>
            <span class="n">uc</span><span class="p">[</span><span class="s2">&quot;cols&quot;</span><span class="p">][</span><span class="n">row</span><span class="o">.</span><span class="n">col_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">col_name</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
             <span class="s1">&#39;column_names&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">uc</span><span class="p">[</span><span class="s2">&quot;cols&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">uc</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]]}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">uc</span> <span class="ow">in</span> <span class="n">uniques</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">]</span>

    <span class="nd">@reflection</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">get_table_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">table_oid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_oid</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span>
                                       <span class="n">info_cache</span><span class="o">=</span><span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;info_cache&#39;</span><span class="p">))</span>

        <span class="n">COMMENT_SQL</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT</span>
<span class="s2">                pgd.description as table_comment</span>
<span class="s2">            FROM</span>
<span class="s2">                pg_catalog.pg_description pgd</span>
<span class="s2">            WHERE</span>
<span class="s2">                pgd.objsubid = 0 AND</span>
<span class="s2">                pgd.objoid = :table_oid</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">COMMENT_SQL</span><span class="p">),</span> <span class="n">table_oid</span><span class="o">=</span><span class="n">table_oid</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">scalar</span><span class="p">()}</span>

    <span class="nd">@reflection</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">get_check_constraints</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">table_oid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_oid</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span>
                                       <span class="n">info_cache</span><span class="o">=</span><span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;info_cache&#39;</span><span class="p">))</span>

        <span class="n">CHECK_SQL</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT</span>
<span class="s2">                cons.conname as name,</span>
<span class="s2">                cons.consrc as src</span>
<span class="s2">            FROM</span>
<span class="s2">                pg_catalog.pg_constraint cons</span>
<span class="s2">            WHERE</span>
<span class="s2">                cons.conrelid = :table_oid AND</span>
<span class="s2">                cons.contype = &#39;c&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">CHECK_SQL</span><span class="p">),</span> <span class="n">table_oid</span><span class="o">=</span><span class="n">table_oid</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
             <span class="s1">&#39;sqltext&#39;</span><span class="p">:</span> <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_load_enums</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_schema_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">supports_native_enum</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="c1"># Load data types for enums:</span>
        <span class="n">SQL_ENUMS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT t.typname as &quot;name&quot;,</span>
<span class="s2">               -- no enum defaults in 8.4 at least</span>
<span class="s2">               -- t.typdefault as &quot;default&quot;,</span>
<span class="s2">               pg_catalog.pg_type_is_visible(t.oid) as &quot;visible&quot;,</span>
<span class="s2">               n.nspname as &quot;schema&quot;,</span>
<span class="s2">               e.enumlabel as &quot;label&quot;</span>
<span class="s2">            FROM pg_catalog.pg_type t</span>
<span class="s2">                 LEFT JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace</span>
<span class="s2">                 LEFT JOIN pg_catalog.pg_enum e ON t.oid = e.enumtypid</span>
<span class="s2">            WHERE t.typtype = &#39;e&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">schema</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="n">SQL_ENUMS</span> <span class="o">+=</span> <span class="s2">&quot;AND n.nspname = :schema &quot;</span>

        <span class="c1"># e.oid gives us label order within an enum</span>
        <span class="n">SQL_ENUMS</span> <span class="o">+=</span> <span class="s1">&#39;ORDER BY &quot;schema&quot;, &quot;name&quot;, e.oid&#39;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">SQL_ENUMS</span><span class="p">,</span> <span class="n">typemap</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;attname&#39;</span><span class="p">:</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">schema</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">bindparams</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">enums</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">enum_by_name</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">enum</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">enum</span><span class="p">[</span><span class="s1">&#39;schema&#39;</span><span class="p">],</span> <span class="n">enum</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">enum_by_name</span><span class="p">:</span>
                <span class="n">enum_by_name</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enum</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">enum_by_name</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">enum_rec</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">enum</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;schema&#39;</span><span class="p">:</span> <span class="n">enum</span><span class="p">[</span><span class="s1">&#39;schema&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;visible&#39;</span><span class="p">:</span> <span class="n">enum</span><span class="p">[</span><span class="s1">&#39;visible&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">enum</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]],</span>
                <span class="p">}</span>
                <span class="n">enums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enum_rec</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">enums</span>

    <span class="k">def</span> <span class="nf">_load_domains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="c1"># Load data types for domains:</span>
        <span class="n">SQL_DOMAINS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT t.typname as &quot;name&quot;,</span>
<span class="s2">               pg_catalog.format_type(t.typbasetype, t.typtypmod) as &quot;attype&quot;,</span>
<span class="s2">               not t.typnotnull as &quot;nullable&quot;,</span>
<span class="s2">               t.typdefault as &quot;default&quot;,</span>
<span class="s2">               pg_catalog.pg_type_is_visible(t.oid) as &quot;visible&quot;,</span>
<span class="s2">               n.nspname as &quot;schema&quot;</span>
<span class="s2">            FROM pg_catalog.pg_type t</span>
<span class="s2">               LEFT JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace</span>
<span class="s2">            WHERE t.typtype = &#39;d&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">SQL_DOMAINS</span><span class="p">,</span> <span class="n">typemap</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attname&#39;</span><span class="p">:</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">Unicode</span><span class="p">})</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">domains</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="c1"># strip (30) from character varying(30)</span>
            <span class="n">attype</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([^\(]+)&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="p">[</span><span class="s1">&#39;attype&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">domain</span><span class="p">[</span><span class="s1">&#39;visible&#39;</span><span class="p">]:</span>
                <span class="c1"># &#39;visible&#39; just means whether or not the domain is in a</span>
                <span class="c1"># schema that&#39;s on the search path -- or not overridden by</span>
                <span class="c1"># a schema with higher precedence. If it&#39;s not visible,</span>
                <span class="c1"># it will be prefixed with the schema-name when it&#39;s used.</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">domain</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="s1">&#39;schema&#39;</span><span class="p">],</span> <span class="n">domain</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

            <span class="n">domains</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;attype&#39;</span><span class="p">:</span> <span class="n">attype</span><span class="p">,</span>
                <span class="s1">&#39;nullable&#39;</span><span class="p">:</span> <span class="n">domain</span><span class="p">[</span><span class="s1">&#39;nullable&#39;</span><span class="p">],</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="n">domain</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">domains</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Girl Effect.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>